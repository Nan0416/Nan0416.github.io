<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_151) on Sun Oct 08 22:41:36 PDT 2017 -->
<title>Clock&nbsp;Systems</title>
<meta name="date" content="2017-12-21">
<meta name="keywords" content="microcontroller">
<meta name="keywords" content="clock">
<meta name="keywords" content="oscillator">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />



</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<center><strong>System&nbsp;-&nbsp;Clock</strong></center>
</div>

<div class="catalog">
<ul class="catalogItems">
<li><a href="#clockSystem">Microcontroller's clock system</a></li>
<li><a href="#clockDomain">Clock domains in Atmega328/p</a></li>
<li><a href="#clockPrescale">System Clock (clk-sys) prescale</a></li>
<li><a href="#clockSource">Clock sources in Atmega328/p</a></li>
<li><a href="#clockExperiments">Clock sources selection experiments</a></li>
<li><a href="#clockReferences">References</a></li>
</ul>
</div>
<hr>

<div class="contentContainer">
<ol>
<li>
<div class="content" id="clockSystem">
<h3>Microcontroller's clock system</h3>
<p><span style="font-weight:bold;">Organization</span>: A microcontroller can have different clock sources, such as an external clock or a crystal oscillator, 
    and serveral components, such as the processor and peripheral devices, of a microcontroller would require clocks. Clock system architecture is 
Clock multiplexer (select clock source) -> prescaled (software, output system clock clk-sys) ->AVR Clock control unit -> different 
sub clock source for those components. The following picture is a clock system in the Atmega328p chip.[1]</p>
<p><img src="./img/clockOrganization.png" title="org" width="400" height="400"></p>
<p class="starMark">* The clki/o and clkcpu have the same clock speed.</p>
<p><span style="font-weight:bold;">Why independent ADC clock domain?</span> It allows the ADC to work while halting the clocks for CPU and I/O clocks. Halting other clocks
 reduces the noise and improve ADC accuracy.</p>
</p>
<div class="termnology">
<h4>Terms</h4>
<ul>
<li>start-up time: a time period before releasing the reset</li>
<li>time-out delay: a ...</li>
<li>BOD: </li>
<li>clock domain: an independent clock source supplied for a component in the microcontroller, such as clk-io and clk-cpu.</li>
</ul>
</div>
</div>
</li>
<li>
<div class="content" id="clockDomain">
<h3>Clock domains in Atmega328/p</h3>
<p>The Atmega328p offers 5 clock domains to CPU, I/O, flash, asynchronous timer and ADC, respectively. Independent clock sources allow the microcontroller to halt unnecessary 
components for saving power.</p>
<div class="featureList">
<h4>Clock domains</h4>
<ol>
<li>clk-cpu: clock AVR core, such as CPU, general purpose register file, PC, SP, the status register, and RAM. Halting the clk-cpu stops performing calculations and other general operations.</li>
<li>clk-flash: clock flash and EEPROM.</li>
<li>clk-io: clock I/O modules, such as SPI, USART, and Timer/Counters.</li>
<li>clk-asy: clock timer/counters. The timer/counters can select clk-io or clk-asy. If the clk-asy is selected, it would be clocked by a real external clock source, different from the system's choices. Then the 
    timer/counter is a real-time counter even the device is in sleep mode.
</li>
<li>clk-adc: clock the ADC peripheral device.</li>
</ol>
</div>
</div>
</li>
<li>
<div class="content" id="clockPrescale">
<h3>System Clock prescale</h3>
<p>The system clock can be divided by configuring the Clock Prescale Register (CLKPR). It allows descrease the system clock frequency and <mark>save power</mark>. It doesn't affect the clk-asy, which is only determined by the Timer/Counter oscillator
clock source.</p>
<p>The system clock is being changed when the system is running. So the prescaler has to guarantee no glitches occurs. To safely switch clk-sys, a special write procedure shown below:</p>
<div class="featureList">
<ol>
<li>write CLKPR.CLKPCE = 1 (Clock Prescaler Register's enable bit) and all other bits to 0. CLKPR = 0x80</li>
<li>within 4 cycles, write desired value to CLKPS[3:0] while writing a zero to CLKPCE = 0. CLKPR = 0x0N</li>
</ol>
</div>
<h4>Code</h4>
<pre class="brush:cpp">
cli(); // disable interrupt because the following instructions need to be done within 4 clock cycles.
CLKPR = 0x80;
CLKPR = 0x08; // set a 256 prescale
sei(); // may enable interrupt again
</pre>
<p class="starMark">* Interrupts must be disabled by software during the modification.</p>
<div class="register">
<h4>Clock Prescaler Register</h4>
<p class="registerComment"></p>
<table class="registerDesc">
<tr><th>No.</th><th>Name</th><th>Meaning</th><th>Default value</th></tr>
<tr><td>7</td><td>CLKPCE</td><td>Enable changing frequency, frequency need to be changed within 4 cycles after set to 1</td><td>0</td></tr>
<tr><td>3</td><td>CLKPS3</td><td></td><td>0</td></tr>
<tr><td>2</td><td>CLKPS2</td><td></td><td>0</td></tr>
<tr><td>1</td><td>CLKPS1</td><td></td><td>0/1</td></tr>
<tr><td>0</td><td>CLKPS0</td><td>CLKPS[3:0] set the prescale of clock source. If CKDIV8 fuse bit is programmed, its initial value is 0011, otherwise 0000</td><td>0/1</td></tr>
</table>
<p class="registerComment">0000 -> 1, 0001 -> 2, 0010 -> 4, 0011 -> 8, ... 1000 -> 256, others are reserved.</p>
</div>
</div>
</li>
<li>
<div class="content" id="clockSource">
<h3>Clock sources in Atmega328/p</h3>
<div class="featureList">
<h4>Atmega328p can select 6 clock sources</h4>
<ol>
<li>calibrated internal RC OSC [default] <span style="color:red">8MHz</span></li>
<li>external crystal oscillator [frequently used e.g. Arduino Nano 16MHz] <span style="color:red">Max. 20MHz</span></li>
<li>external clock</li>
<li>Real timer/counter oscillator</li>
<li>Low-frequency crystal oscillator</li>
</ol>

</div>
<p>System startup: A successful microcontroller startup needs a stable voltage and a stable clock source. After just powering the system, the Vcc pin's voltage may not be stable thinks to capacitance and other factors.
The system would delay a short period in order to give time (<mark>time-out delay</mark>) to the Vcc pin to reach the valid voltage. Also the clock source may also not reach the stable status. It needs to run a few cycles (<mark>start-up time</mark>) 
before claiming it is stable. Different power types and clock sources have distinctive time-out delay and start-up time. They are configured by the Low fuse btyes (<span style="font-style:italic;color:gray;">[Divided by 8, ck out, SUT (start-up time), CKSELn (clock source selection)]</span>).
</p>
<div class="featureList">
<h4>Defined power type</h4>
<ol>
<li>BOD enabled: BOD circuit holds the reset until Vcc reaches the minimum required voltage for a time-out delay time.</li>
<li>Fast rising power</li>
<li>Slowly rising power</li>
</ol>
</div>
<div class="featureList">
<h4>Clock sources</h4>
<ol>
<li>The calibrated internal 8MHz RC oscillator is the default clock source (CKSELn = 0010). Because the CKDIV8 is programmed by default, the clk-sys is 1 MHz.</li>
<li><p>The low power crystal oscillator can be used with a quartz crystal or ceramic resonate (CSKELn=1111-1000). It is susceptible to noise in noisy environment but save power compared to the external oscillator. The
frequency can range from 0.4MHz to 20MHz, CKSEL are distinctive for different range.</p>
<p>The circuit used by low power crystal oscillator is shown below [2], the capacitance ofc2 and c2 must be same.</p>
<p><img src="./img/lowPowerCrystalOscillator.png" width="200" height="170"></p>
</li>
</ol>
</div>
</div>
</li>
<li>
<div class="content" id="clockExperiments">
<h3>Clock sources selection experiments</h3>
<p>Arduino uses a low power crystal oscillator that runs at 16MHz with CKSEL=1111, SUT=11 (16K cycle start-up + 14 cycle + 65ms time-out delay). Design a program that blink a led for one second. 
Use the same code but setting the fuse bits to use internal RC 8MHz.
</p>
</div>
</li>
<li>
<div class="content" id="clockReferences">
<h3>References</h3>
<p>[1][2] Atmega328p datasheet. Page 48 and Page 51.
</p>
</div>
</li>

</ol>
</div>

</body>
</html>
