<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<title>FreeRTOS&nbsp;Task</title>
<meta charset="utf-8">
<meta name="date" content="2018-11-14">
<meta name="keywords" content="">
<meta name="keywords" content="">
<meta name="keywords" content="">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />

<script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<strong>&nbsp;-&nbsp;</strong>
</div>
<p class="date"><span class="created-date">Created:2018-11-14</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2018-11-14</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#intro">Create</a></li>
<li><a href="#detail">Detail</a></li>
<li><a href="#reference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="intro">
<h3>Create</h3>
<h4>C knowledge</h4>
<div class="featureList">
    <ol>
        <li>
            macro ##: concatenate variable name: e.g. #define con(a, b) a##b
            <br>int con(x, y) = 10;
            <br>printf("%d\n", xy);
        </li>
        <li>
            macro #: convert variable name to string: e.g. #define str(a) #a
            <br>printf("%s\n", str(hello));
        </li>
        <li>
            define function pointer<br>
            typedef void (*os_pthread) (void const *argument);<br>
            os_pthread is a function type that takes a const * as argument and return void
        </li>
        <li>
            Code analysis <span style="color:red">Based on dynamic allocation, task stack is allocated by this function instead of allocated by application developers.</span>
            <pre class="brush:cpp">
                    osThreadId DefaultTaskHandle;
                    void thread1(void const * argument);
            
                    osThreadDef(DefaultTask, thread1, osPriorityNormal, 0, 128);
                    DefaultTaskHandle = osThreadCreate(osThread(DefaultTask), NULL);
            

                ///// equivalent
                    void * DefaultTaskHandle = xTaskCreate( thread1, // defined by FreeRTOS
                       "DefaultTask",
                       128, // 4x size
                        NULL,
                        UBaseType_t uxPriority,
                       // &DefaultTaskHandle )

            
                    /////////////////////////// Inside /////////////////////////////////
                    
                    #define osThreadDef(name, thread, priority, instances, stacksz)  \
                    const osThreadDef_t os_thread_def_##name = \
                    { #name, (thread), (priority), (instances), (stacksz)}
            
                    typedef struct os_thread_def  {
                        char                   *name;        /// Thread name 
                        os_pthread             pthread;      /// start address of thread function
                        osPriority             tpriority;    /// initial thread priority
                        uint32_t               instances;    /// maximum number of instances of that thread function
                        uint32_t               stacksize;    /// stack size requirements in bytes; 0 is default stack size
                      #if( configSUPPORT_STATIC_ALLOCATION == 1 )
                        uint32_t               *buffer;      /// stack buffer for static allocation; NULL for dynamic allocation
                        osStaticThreadDef_t    *controlblock;     /// control block to hold thread's data for static allocation; NULL for dynamic allocation
                      #endif
                      } osThreadDef_t;
            
                    
                    
                    
                    osThreadDef(DefaultTask, thread1, osPriorityNormal, 0, 128);    /// =>
                    const osThreadDef_t os_thread_def_DefaultTask = {
                        "DefaultTask", 
                        thread1,
                        osPriorityNormal,
                        0,
                        128
                    };
            
            
                    typedef TaskHandle_t osThreadId; // defined by cmsis_os.h
                    typedef void * TaskHandle_t; // defined by FreeRTOS's task.h
            
                    osThreadId osThreadCreate (const osThreadDef_t *thread_def, void *argument)
                    {
                        TaskHandle_t handle;
                        
                        /*#if( configSUPPORT_STATIC_ALLOCATION == 1 ) &&  ( configSUPPORT_DYNAMIC_ALLOCATION == 1 )
                        if((thread_def->buffer != NULL) && (thread_def->controlblock != NULL)) {
                            handle = xTaskCreateStatic((TaskFunction_t)thread_def->pthread,(const portCHAR *)thread_def->name,
                                    thread_def->stacksize, argument, makeFreeRtosPriority(thread_def->tpriority),
                                    thread_def->buffer, thread_def->controlblock);
                        }
                        else {
                            if (xTaskCreate((TaskFunction_t)thread_def->pthread,(const portCHAR *)thread_def->name,
                                    thread_def->stacksize, argument, makeFreeRtosPriority(thread_def->tpriority),
                                    &handle) != pdPASS)  {
                            return NULL;
                            } 
                        }
                        #elif( configSUPPORT_STATIC_ALLOCATION == 1 )
            
                            handle = xTaskCreateStatic((TaskFunction_t)thread_def->pthread,(const portCHAR *)thread_def->name,
                                    thread_def->stacksize, argument, makeFreeRtosPriority(thread_def->tpriority),
                                    thread_def->buffer, thread_def->controlblock);
                        #else*/
                        if (xTaskCreate((TaskFunction_t)thread_def->pthread,(const portCHAR *)thread_def->name,
                                        thread_def->stacksize, argument, makeFreeRtosPriority(thread_def->tpriority),
                                        &handle) != pdPASS)  {
                            return NULL;
                        }     
                        #endif
                
                        return handle;
                    }
            
                    BaseType_t xTaskCreate(	TaskFunction_t pxTaskCode, // defined by FreeRTOS
                                        const char * const pcName,
                                        const uint16_t usStackDepth,
                                        void * const pvParameters,
                                        UBaseType_t uxPriority,
                                        TaskHandle_t * const pxCreatedTask ) /*lint !e971 Unqualified char types are allowed for strings and single characters only. */
                    {
                    TCB_t *pxNewTCB;
                    BaseType_t xReturn;
            
                        {
                        StackType_t *pxStack;
            
                            /* Allocate space for the stack used by the task being created. */
                            // #define portSTACK_TYPE	uint32_t4
                            // typedef portSTACK_TYPE StackType_t;
                            pxStack = ( StackType_t * ) pvPortMalloc( ( ( ( size_t ) usStackDepth ) * sizeof( StackType_t ) ) ); /*lint !e961 MISRA exception as the casts are only redundant for some ports. */
            
                            if( pxStack != NULL )
                            {
                                /* Allocate space for the TCB. */
                                pxNewTCB = ( TCB_t * ) pvPortMalloc( sizeof( TCB_t ) ); /*lint !e961 MISRA exception as the casts are only redundant for some paths. */
            
                                if( pxNewTCB != NULL )
                                {
                                    /* Store the stack location in the TCB. */
                                    pxNewTCB->pxStack = pxStack;
                                }
                                else
                                {
                                    /* The stack cannot be used as the TCB was not created.  Free
                                    it again. */
                                    vPortFree( pxStack );
                                }
                            }
                            else
                            {
                                pxNewTCB = NULL;
                            }
                        }
                        #endif /* portSTACK_GROWTH */
            
                        if( pxNewTCB != NULL )
                        {
                            prvInitialiseNewTask( pxTaskCode, pcName, ( uint32_t ) usStackDepth, pvParameters, uxPriority, pxCreatedTask, pxNewTCB, NULL );
                            prvAddNewTaskToReadyList( pxNewTCB );
                            xReturn = pdPASS;
                        }
                        else
                        {
                            xReturn = errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY;
                        }
            
                        return xReturn;
                    }
            </pre>
        </li>
    </ol>
</div>
</div>
</li>
<li>
    <div class="content" id="detail">
        <h3>Details</h3>
        <div class="featureList">
            <ol>
                <li>
                    <h4>TCB structure</h4>
                    <pre class="brush:cpp">
                        typedef tskTCB TCB_t;
                    </pre>
                </li>
            </ol>
        </div>
        
        <h4>prvInitialiseNewTask</h4>
        <h4>prvAddNewTaskToReadyList</h4>
        

            
    </div>
</li>
<li>
<div class="content" id="reference">
<h3>References</h3>
<div class="featureList">
    <ol>
        <li><a href="https://www.freertos.org/a00125.html" target="_blank">xTaskCreate</a></li>
    </ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
