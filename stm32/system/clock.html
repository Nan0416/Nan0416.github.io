<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_151) on Sun Oct 08 22:41:36 PDT 2017 -->
<title>STM32F1&nbsp;Clock</title>
<meta charset="utf-8">
<meta name="date" content="2018-02-09">
<meta name="keywords" content="clock">
<meta name="keywords" content="stm32">
<meta name="keywords" content="cortex-m">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />



</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<center><strong>STM32F1&nbsp;-&nbsp;Clock</strong></center>
</div>
<p class="date"><span class="created-date">Created:2018-02-09</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2018-02-09</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#clockIntro">Introduction</a></li>
<li><a href="#clockSource">Clock sources</a></li>
<li><a href="#clockSys">System clock</a></li>
<li><a href="#clockRegister">Clock registers</a></li>
<li><a href="#clockProgramming">Clock Programming</a></li>
<li><a href="#clockReference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="clockIntro">
<h3>Introduction</h3>
<p>The system clock of stm32F1 can reach 72MHz. Different from AVR microcontroller that changes clock source by using fuse bits, 
    the stm32 clock source can be changed at runtime by modifying registers. </p>
</div>
</li>
<li>
<div class="content" id="clockSource">
<h3>Clock sources</h3>
<div class="featureList">
<h4>clock source can be used as the system clock (Sysclk)</h4>
<p>The maximum input clock frequency to Sys is 72MHz</p>
<ol>
<li>HSI (high speed internal clock): a 8 MHz RC ,less accurate than HSE.</li>
<li>HSE (high speed external clock): can be a crystal/ceramic resonator or an external clock circuit.</li>
<li>PLL (Phase-locked loop): taking either HSI/2 or HSE as input to generate a higher frequency clock.</li>
</ol>
<h4>clock source can drive USB</h4>
<ol>
<li>PLL</li>
</ol>
<h4>clock source can drive RTC</h4>
<ol>
<li>HSE /128</li>
<li>LSE (32.768KHz)</li>
<li>LSI 40KHz RC</li>
</ol>
<p><span style="color:red">When using LSE, the RTC can continue to work without Vdd but using Vbat (voltage of the battery)</span> Then the LSE is said in the backup domain.</p>
<h4>clock source can driver independent watchdog</h4>
<ol>
<li>LSI 40KHz RC</li>
</ol>
</div>
 <p><img src="./img/clock.png" width="700" height="900"></p>
 <h4>Clock security system (CSS)</h4>
<p>When using HSE or HSE + PLL as system clock source, this feature can be used.</p>
<p>This component can be enabled by software to monitor the HSE. If HSE or HSE + PLL fails, it switch the clock source to HSI and the HSE or HSE + PLL is 
disabled and cause a NMI (Non maskable interrupt).</p>  
<h4>MCO (microcontroller clock output)</h4>
<p>4 clock can be output 1). sysclk, 2). HSI, 3). HSE 4) PLL clock divided by 2</p>
</div>

</li>
<li>
<div class="content" id="clockSys">
<h3>System clock</h3>
<div class="featureList">
<ol>
<li><span style="color:red">The hardware default is using HSI oscillator.</span></li>
</ol>
</div>
</div>
</li>
<li>
<div class="content" id="clockRegister">
<h3>Clock registers</h3>
<div class="featureList">
<h4>Control</h4>
<ol>
<li><strong><i>CSR</i></strong>: a flag that remember which source cause the system reset, e.g. watchdog, low-power</li>
</ol>
<h4>Source selection</h4>
<ol>
<li><strong><i>RC (Clock control register)</i></strong>: PLL ready-enable, HSI ready-enable, HSI calibration, HSE ready-enable/enable-external, CSS enable
<br>Set and polling test ready flag.</li>
<li><strong><i>CFGR (Clock configuration register)</i></strong>: select/check system clock source; MCO source selection; USB prescaler;  HSE prescaler for PLL, PLL source, PLL prescaler; ADC Prescaler; AHB, APB1/2 prescaler</li>
<li><strong><i>CIR</i></strong>:set to clear clock interrupt flag, e.g. CSS, PLL ready; enable interrupt; interrupt flag;
<br>The way to clear interrupt flag is different from AVR microcontroller, there is a individual bit used to clear flag.</li>
<li><strong><i>BDCR</i></strong>: reset the backup domain, enable RTC, select RTC source, LSE enable/ready bypass it in case of debugging.</li>
<li><strong><i>CSR</i></strong>: LSI enable/ready</li>
</ol>

<h4>Peripheral device reset</h4>
<ol>
<li><strong><i>APB2RSTR / ARB1RSTY</i></strong>: reset the peripheral devices on APB2/1, e.g. Timers, uart<br>
AVR does not have this feature</li>
</ol>
<h4>Clock distribution</h4>
<ol>
<li><strong><i>AHBENR</i></strong>: enable the clock for each peripherals on the AHB, e.g. SRAM, DMA1/2, CRC, <stron>SDIO (sd card)</stron>, FSMC (flexible static memory controller 外接存储), FLITF (flash memory instruction intreface)<br>
reset value will enable SRAM and FLITF.
<br>When a peripher is disable, trying to read its register would return 0x0.</li>
<li><strong><i>APB2/1ENR</i></strong>: enable peripherals</li>
</ol>
</div>
</div>
</li>
<li>
<div class="content" id="clockProgramming">
<h3>Clock programming</h3>
<div class="featureList">
<ol>
<li><h4>Hardware reset</h4>
<p>Clock: 8 MHz HSI without PLL, all APB peripherals disabled, only Flash and ROM is accessible.</p>
</li>
<li><h4>SystemInit(); invoked by startup.S</h4></li>
<p>Clock: No MCO, HSI directly used as system clock. (done by direct access register in C)</p>
<li><h4>User clock init(); invoked from the main</h4>
<p>
<pre class="brush:cpp">
void SystemClock_Config(void)
{

  RCC_OscInitTypeDef RCC_OscInitStruct;
  RCC_ClkInitTypeDef RCC_ClkInitStruct;

    /**Initializes the CPU, AHB and APB busses clocks 
    */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
  RCC_OscInitStruct.HSIState = RCC_HSI_ON;
  RCC_OscInitStruct.HSICalibrationValue = 16;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_NONE;
  if (HAL_RCC_OscConfig(&amp;RCC_OscInitStruct) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }

    /**Initializes the CPU, AHB and APB busses clocks 
    */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_HSI;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;

  if (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStruct, FLASH_LATENCY_0) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }

    /**Configure the Systick interrupt time 
    */
  HAL_SYSTICK_Config(HAL_RCC_GetHCLKFreq()/1000);

    /**Configure the Systick 
    */
  HAL_SYSTICK_CLKSourceConfig(SYSTICK_CLKSOURCE_HCLK);

  /* SysTick_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(SysTick_IRQn, 0, 0);
}
</pre>
<pre class="brush:cpp">
/** 
  * @brief  RCC Internal/External Oscillator (HSE, HSI, LSE and LSI) configuration structure definition  
  */
typedef struct
{
  uint32_t OscillatorType;       /*!&lt; The oscillators to be configured.
                                       This parameter can be a value of @ref RCC_Oscillator_Type */

#if defined(STM32F105xC) || defined(STM32F107xC)
  uint32_t Prediv1Source;       /*!&lt;  The Prediv1 source value.
                                       This parameter can be a value of @ref RCCEx_Prediv1_Source */
#endif /* STM32F105xC || STM32F107xC */

  uint32_t HSEState;              /*!&lt; The new state of the HSE.
                                       This parameter can be a value of @ref RCC_HSE_Config */
                          
  uint32_t HSEPredivValue;       /*!&lt;  The Prediv1 factor value (named PREDIV1 or PLLXTPRE in RM)
                                       This parameter can be a value of @ref RCCEx_Prediv1_Factor */

  uint32_t LSEState;              /*!&lt;  The new state of the LSE.
                                        This parameter can be a value of @ref RCC_LSE_Config */
                                          
  uint32_t HSIState;              /*!&lt; The new state of the HSI.
                                       This parameter can be a value of @ref RCC_HSI_Config */

  uint32_t HSICalibrationValue;   /*!&lt; The HSI calibration trimming value (default is RCC_HSICALIBRATION_DEFAULT).
                                       This parameter must be a number between Min_Data = 0x00 and Max_Data = 0x1F */
                               
  uint32_t LSIState;              /*!&lt;  The new state of the LSI.
                                        This parameter can be a value of @ref RCC_LSI_Config */

  RCC_PLLInitTypeDef PLL;         /*!&lt; PLL structure parameters */      

#if defined(STM32F105xC) || defined(STM32F107xC)
  RCC_PLL2InitTypeDef PLL2;         /*!&lt; PLL2 structure parameters */      
#endif /* STM32F105xC || STM32F107xC */
} RCC_OscInitTypeDef;
</pre>
<pre class="brush:cpp">
/** 
  * @brief  RCC PLL configuration structure definition  
  */
typedef struct
{
  uint32_t PLLState;      /*!&lt; PLLState: The new state of the PLL.
                              This parameter can be a value of @ref RCC_PLL_Config */

  uint32_t PLLSource;     /*!&lt; PLLSource: PLL entry clock source.
                              This parameter must be a value of @ref RCC_PLL_Clock_Source */          

  uint32_t PLLMUL;        /*!&lt; PLLMUL: Multiplication factor for PLL VCO input clock
                              This parameter must be a value of @ref RCCEx_PLL_Multiplication_Factor */
} RCC_PLLInitTypeDef;
</pre>
</p></li>
</ol>
</div>
</div>
</li>
<li>
<div class="content" id="clockReference">
<h3>Reference</h3>
<div class="featureList">
<ol>
<li><a href="">STM32F103 datasheet</a></li>
</ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
