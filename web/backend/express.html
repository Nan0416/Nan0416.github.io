<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_151) on Sun Oct 08 22:41:36 PDT 2017 -->
<title>NodeJS&nbsp;Express</title>
<meta charset="utf-8">
<meta name="date" content="2018-04-07">
<meta name="keywords" content="express">
<meta name="keywords" content="nodejs">
<meta name="keywords" content="backend">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />



</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<center><strong>NodeJS&nbsp;-&nbsp;Express</strong></center>
</div>
<p class="date"><span class="created-date">Created:2018-04-07</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2018-04-07</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#expressIntro">Introduction</a></li>
<li><a href="#expressMiddleware">Middleware</a></li>
<li><a href="#expressRequest">Request</a></li>
<li><a href="#expressResponse">Response</a></li>
<li><a href="#expressGenerator">Express Generator</a></li>
<li><a href="#expressReference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="expressIntro">
<h3>Introduction</h3>
<p>Express is a NodeJS package that provides a web framework. The heart of express is middleware.</p>
<p>Middleware is a function that take three arguments (request, response, next)</p>
<div class="featureList">
<ol>
<li>request: a http request object</li>
<li>response: a http response object</li>
<li>next: a function that can invoke the next middleware</li>
</ol>
<p>The express framework's duties: 
<div class="featureList">
<ol>
<li>listening http requests</li>
<li>routing requests to specific endpoints</li>
<li>invoking the middleware flow</li>
</ol>
</div>
<h4>Middleware flow</h4>
<p>The express organizes these middleware (functions) as a flow.</p>
<pre class="brush:js">
app.use(morgan); // logging service
app.use(bodyparser); // parsing http body
//app.use(.....)
</pre>
<p>When a http request is routed to a endpoint, the express first does the morgan middleware. The mogran reads
     some data from the http request, and then calls next() to invoke next middleware. The bodyparser analyzes
      the http request body and adds new properties to the request object and then call next()...</p>
</div>
</div>
</li>
<li>
<div class="content" id="expressMiddleware">
<h3>Middleware</h3>
<p>There are two types of middleware: routing middleware and application middleware.</p>
<p><strong>Routing middleware</strong>: when a http request comes in, the rounte middleware will send the http request to a specific middleware (mini-application)</p>
<p><strong>Application middleware</strong>: analyzes and modifies the request and response objects.</p>
<p class="starMark">* Another type is the parameter filter</p>
<h4>Routing middleware</h4>
<pre class="brush:js">
const express = require('express');
const dishRounter = express.Router(); // returns a function object
dishRounter.route('/') // function 
.all((req, res, next) => {
    res.statusCode = 200;
    res.setHeader('Content-Type', 'text/plain');
    next();
})
.get((req, res, next) => {
    res.end('Will send all the dishes to you!');
})
.post((req, res, next) => {
    res.end('Will add the dish: ' + req.body.name + 
    ' with details: ' + req.body.description);
})
.put((req, res, next) => {
    res.statusCode = 403;
    res.end('PUT operation not supported on /dishes');
})
.delete((req, res, next) => {
    res.end('Deleting all the dishes!');
});
module.exports = dishRounter;
</pre>
<div class="featureList">
<h4>Method of the router object</h4>
<ol>
<li>express.Router([options]): creates a new router object. [options] control case-senitive, strict-routing</li>
<li>.route(path): creates a new endpoint, returns the sub-router app instance.
<p>The path can include param.</p>
<h4>Path</h4>
<p>The path can be string '/book', string pattern /a/, or regex</p>
<p>parameters are interrupt as :param_name, and stored in the req.params</p>
<pre class="brush:js">
// http://localhost:3000/user/qinnan/books/os
app.get('/user/:userId/books/:bookId', (req, res) => {
    var id = req.params.userId; // qinnan
    var bid = req.params.bookId; // os
});
</pre>
<p>- and . are interrupted literally. (不被当做parameter value的一部分)</p>
<pre class="brush:js">
// http://localhost:3000/user/qinnan/books/os-v5
// can match '/user/:userId/books/:bookId', bookId = os-v5
app.get('/user/:userId/books/:bookId-:version', (req, res) => {
    var id = req.params.userId; // qinnan
    var bid = req.params.bookId; // os
    var version = req.params.version // v5
});
</pre>
</li>
<li>.param(name, callback): creates a parameter filter
<p>The purpose of the param filter will chech the parameter. If the parameter is valid, then it will allow to further process.</p>
<pre class="brush:js">
// callback (req, res, next, value) // value is the parameter's value
const express = require("express");
const addition = express.Router();
addition.param("operation", (req, res, next, id) => {
    console.log(id);
    if(id != 'add' &amp;&amp; id != 'mul' &amp;&amp; id != 'div' &amp;&amp; id != 'sub'){
      res.statusCode = 403;
      res.setHeader('Content-Type', 'text/plain');
      res.end('invalid operation');
    }else{

      next();
    }
});
addition.param('first', (req, res, next, id) => {
    var num = Number(id);
    if (num){
      req.params.first = num;
      next();
    } else {
      res.statusCode = 403;
      res.setHeader('Content-Type', 'text/plain');
      res.end('invalid parameters');
    }
});
addition.param('second', (req, res, next, id) => {
    var num = Number(id);
    if (num){
      req.params.second = num;
      next();
    } else {
      res.statusCode = 403;
      res.setHeader('Content-Type', 'text/plain');
      res.end('invalid parameters');
    }
});
addition.route('/:operation/:first.:second')
.get((req, res, next) => {
    var num = 0;
    switch(req.params.operation){
      case 'add': num = req.params.first + req.params.second;break;
      case 'mul': num = req.params.first * req.params.second;break;
      case 'sub': num = req.params.first - req.params.second;break;
      case 'div': num = req.params.first / req.params.second;break;
      default:break;
    }

    res.statusCode = 200;
    res.setHeader('Content-Type', 'text/plain');
    res.end(num + "");
});

module.exports = addition;
</pre>

</li>
<li>
.Method() / .all()
</li>
<li>
.use()
</li>
</ol>
</div>
<h4>Application Middleware</h4>
<div class="featureList">
<ol>
<li>
<span style="color:red">morgan</span> a logger plug-in
<pre class="brush:js">
const morgan = require('morgan'); // 1.9.0
app.use(morgan('dev'));

// GET /dishes/1 500 15.014 ms - 1867
// Method, URL, Status Code, Server Handling Time, -, Size of Response Body
</pre>
</li>
<li>
<span style="color:red">body-parser</span> parsing json body request
<pre class="brush:js">
const bodyparser = require('body-parser'); // 

app.use(bodyparser.json());
app.use(bodyParser.urlencoded({ extended: true })); // 解析form？
// for parsing application/x-www-form-urlencoded

</pre>
</li>

</ol>
</div>
</div>
</li>
<li>
<div class="content" id="expressRequest">
<h3>Request</h3>
<p>Express request object</p>
<div class="featureList">
<ol>
<li>
<span style="color:red">Express built-in functionality</span> Parameters from the url e.g. /:dishId
<pre class="brush:js">
    // /:dishId
    req.params.dishId
    // /file/* regex, 
    req.params[0]
</pre>
</li>
<li>
<span style="color:red">Express Middleware functionality</span> Body content from http request body
<pre class="brush:js">
var bodyParser = require('body-parser');

app.use(bodyParser.json()); // for parsing application/json
app.use(bodyParser.urlencoded({ extended: true })); // for parsing application/x-www-form-urlencoded

req.body // a object
req.body.name.first
req.body["age"]
</pre>
</li>
</ol>
</div>
</div>
</li>
<li>
<div class="content" id="expressResponse">
<h3>Response</h3>
<p>Express response object</p>
<div class="featureList">
<ol>
<li>
<span style="color:red">Express built-in</span> .status() .statusCode
<pre class="brush:js">
res.statusCode = 200; // node http
res.status(200).send('data'); // express chainable wrapper
</pre>
</li>
<li>
<span style="color:red">Express built-in</span> .setHeader .type
<pre class="brush:js">
res.setHeader('Content-Type', 'application/json'); // node http
res.type('application/json'); // express wrapper
// using this method, we can .type('json'). The function will convert it into 'application/json'
// others .type('html'), .type('png')
</pre>
</li>
<li>
<span style="color:red">From node http core</span> .end()
<pre class="brush:js">
res.end();
res.end('string');
// this method can only be called once for one http request.
</pre> 
</li>
<li>
<li>
<span style="color:red">Express built-in</span> .json()
<pre class="brush:js">
res.json(obj);
// It convert a method to a json string. It uses the JSON.stringfy() internally.
// It also calls the .end
</pre> 
</li>
<li>
</li>
</ol>
</div>
</div>
</li>
<li>
<div class="content" id="expressGenerator">
<h3>Express Generator</h3>
<p>A command line tool that generates an express application skeleton</p>
<pre class="brush:js">
# installation 
npm install express-generator -g 
# usage 
express <app_name> 
# install project dependencies 
npm install
</pre> 
<div class="featureList">
<h4>Structure of express generator project</h4>
<ol>
<li>app.js // index.js the main file but not the start file</li>
<li>bin // configure the http server, e.g. port, hostname, the start-up file</li>
<li>package.json</li>
<li>public // static resources</li>
<li>routes // application routes</li>
<li>views // template engine templates</li>
</ol>
</div>
<h4>Error handler</h4>
<p>The generated project provided a error handler</p>
<p>The last two middleware functions are</p>

<pre class="brush:js">
// catch 404 and forward to error handler
app.use(function(req, res, next) {
  next(createError(404));
});

// error handler
app.use(function(err, req, res, next) {
  // set locals, only providing error in development
  res.locals.message = err.message;
  res.locals.error = req.app.get('env') === 'development' ? err : {};

  // render the error page
  res.status(err.status || 500);
  res.render('error');
});
</pre>
<p>Therefore, whenever a error happens during the previous middleware functions, just call next to transfer the error to the last two functions</p>
<p>Successful handling should .end the response and stop next early</p>
</div>
</li>
<li>
<div class="content" id="expressReference">
<h3>References</h3>
<div class="featureList">
<ol>
<li><a href="http://evanhahn.com/understanding-express/" target="_blank">Understanding express</a></li>
</ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
