<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<title>Tools&nbsp;Mailgun</title>
<meta charset="utf-8">
<meta name="date" content="2019-11-08">
<meta name="keywords" content="mailgun">
<meta name="keywords" content="email">
<meta name="keywords" content="auto">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushPython.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushSql.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />

<script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<strong>Tools&nbsp;-&nbsp;Mailgun</strong>
</div>
<p class="date"><span class="created-date">Created:2019-11-08</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2019-11-08</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#intro">Introduction</a></li>
<li><a href="#reference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="intro">
<h3>Introduction</h3>
<p>Mailgun is a email service that allows setup customized domain.</p>
<div class="featureList">
    <ol>
        <li>
            <h4>How does email works?</h4>
            <p>Email service providers (e.g. gmail, mailgun) setup mail servers, and provide user-agent (mail app clients) to users.</p>
            <p>Users write emails on user-agent and send to email servers via whatever protocols, such as HTTP, and then a email server sends this email to recipient's email server via 
                SMTP, POP3, or IMAP protocols.
            </p>
        </li>
        <li><h4>Outbound email</h4>
            <p>In theory, anyone can directly setup a connection with the recipient's mail server, and directly deposit an email to recipient's mail server. At this time, the sender can declare himself with any sender's email address. In other words, the sender can tell the recipient's server that he is ceo@nike.com, and the recipient's server has to figure out some ways to verify the sender's identity.</p>
            <p>SPF: spf is a protocol to setup some TXT record on DNS with contains a list of valid sender IP. For examlple, Nike can setup nike.com with</p>
            <pre class="brush:bash">
                v=spf1 include:mailgun.org ~all # meaning an email is valid only if it's sent from the mailgun.org server.
            </pre>
            <p>In this case, the recipient server can ask the TXT record from the nike.com and see whether the sender's ip is valid.</p>
            <p>DKIM is another protocol for protecting the sender's identity. It use public/private key with signature. It stores its public key as a DNS TXT record, so anyone can access it. When the sending an email, the sender's server uses its private key to add a signature on this email. Later on the recipient can acquire the public key from DNS server and validate the signature.</p>
            <pre class="brush:bash">
                k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDC1z3NIsE4Su2POkHK1d0U9h4VG5zAlROmwatY6KxNaOtqloNe/KQZYg+rEOgiUmSimom2AfO0yTABDIm3z6M0uFFjkxPzIIkpggWbhhHofKIeWToBCP1XjiVPzutYF46MSez1oN8mb8TZVg9ZBRFmn5XeDAkY+dMIbnvNeYRsQIDAQAB
            </pre>
            <p>The key-pair is usually generated by the mail's service provider.</p>
        </li>
        <li>
            <h4>Inbound email</h4>
            <p>When sending a email to ceo@qinnan.dev, the sender's server first needs to know the ip address of the recipient's mail server via DNS lookup. In this case, it looks at the <span style="color:red">MX record of qinnan.dev</span></p>
            <p>When an email is delivered to the recipient's server, the recipient server has different options to choose.<br>
                1). gmail: stores into the recipient's inbox<br>
                2). mailgun: configurable, forward to another email, invoke a callback function, store its on mailgun server.<br>
            </p>
            <p>The recipient's username doesn't matter, it depends on how the recipient's server handle it. For a programmable service, such as mailgun, it's just used as a parameter for functions.</p>
        </li>
        <li>
            <h4>Forward inbound email with DNS service provider</h4>
            <p>Google domain can forward email send to *@yourdomain.com to an another email address.</p>
        </li>
    </ol>
</div>
</div>
</li>
<li>
    <div class="content" id="mailgun">
        <h3>Mailgun in action</h3>
        <div class="featureList">
            <ol>
                <li><h4>Current (Nov 9th, 2019) pricing</h4>
                    <p>It's free for the first 10,000 outbound email, and free for unlimit inbound email. But depends on how to handle inbound emails, it still has cost. For example, if you select to forward inbound email to another address, then each forward will be count as a outbound email.</p>
                </li>
                <li><h4>Add a new domain</h4>
                    <p>Create a new domain under the "Sending", add the supply DNS records to DNS service.</p> 
                    <h4>Subdomain</h4>
                    <p>The SPF and DKIM records configured for a subdomain also workds for root domain. In other words, you can setup the SPF and DKIM records for a subdomain, but send emails with the root domain.</p>
                    <p>However, you cannot use the root domain to <span style='color:red'>receive</span> email if you create subdomain with Mailgun. Adding the MX record for root domain also doesn't work. </p>
                    <p>But you can use DNS provider e.g. Google Domain, to forward inbound root-domain email to another email address. Mailgun subdomain MX record and DNS email rootdomain forward can co-exist.</p>
                    <h4>Wildcard subdomin</h4>
                    <p>If you configure a root domain in mailgun, then it can allow you to receive at sub-domain "wildcard domain", but you will need to add MX record in DNS.</p>
                </li>
                <li>
                    <h4>Sending email with Node.js</h4>
                    <p>mailgun provide nodejs library for sending email, the configuration needs the domain name e.g. "mg.qinnan.dev" and the private api key that can be accessed in mailgun website.</p>
                    <pre class="brush:bash">
                        npm install mailgun-js
                    </pre>
                    <pre class="brush:javascript">
                        const mailgunjs = require('mailgun-js');
                        const mailgun = mailgunjs({apiKey: private_api_key, domain: domain});

                        const data = {
                            from: 'Excited User &lt;me@samples.mailgun.org>',
                            to: 'foo@example.com, bar@example.com', // it supports multiple recipient.
                            subject: 'Hello',
                            text: 'Testing some Mailgun awesomeness!'
                            };
                        mailgun.messages().send(data, (err, body) => {
                            // possible error
                            // Forbidden (invalid private api key)
                            // Domain not found: qinnan.dev (invalid domain name)
                            // a successful body response.
                            { 
                                id: '&lt;20191109071039.1.44593B62C7AC34C3@mg.qinnan.dev>',
                                message: 'Queued. Thank you.' 
                            }
                        })
                    </pre>
                    <p>Mailgun support 3 different message format. SendData, BatchData, SendTemplateData. <a href="./resources/index.js">reference</a></p>
                </li>
                <li>
                    <h4>Receiving email</h4>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
<div class="content" id="reference">
<h3>References</h3>
<div class="featureList">
    <ol>
        <li><a href="https://documentation.mailgun.com/en/latest/user_manual.html#introduction" target="_blank">Mailgun document.</a></li>
        <li><a href="https://github.com/bojand/mailgun-js" target="_blank">Github - mailgun-js</a></li>
    </ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
