<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_151) on Sun Oct 08 22:41:36 PDT 2017 -->
<title>ASM&nbsp;AVR Instruction set</title>
<meta charset="utf-8">
<meta name="date" content="2018-01-23">
<meta name="keywords" content="asm">
<meta name="keywords" content="avr&nbsp;instruction">
<meta name="keywords" content="microcontroller">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />
</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<center><strong>ASM&nbsp;-&nbsp;AVR Instruction set</strong></center>
</div>
<p class="date"><span class="created-date">Created:2018-01-23</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2018-01-23</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#instructionIntro">Introduction</a></li>
<li><a href="#instructionInstr">Instructions</a></li>
<li><a href="#powerReferences">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="instructionIntro">
<h3>Introduction</h3>
<p>Most AVR-instructions are 16-bit length with single execution cycle. Therefore, the PC's value is a word, which means PC+1 actually goes forward 2 bytes.</p>
<p>It is just one pipeline (or no pipeline), but reading register, ALU, and storing back happen in a single cycle.</p>
<p>Instruction types include 1) data transfer instruction; 2) arithmetic &amp; logic; 3) branch instructions; 4) bit manuiplation; 5) MCU control</p>
</div>
</li>
<li>
<div class="content" id="instructionInstr">
<h3>Instructions</h3>
<div class="featureList">
<ol>
<li>
<h4>Data transfer instructions</h4>
<p>Data transfer instructions transfer data between register -> register, register -> SRAM memory, immediate -> register, SRAM memory -> register.</p>
<p>It is also possible to load/store data between register and flash program memory. For example, in bootloader. (LPM instruction ...)</p>
<div class="generalTable">
<h4>register - > register</h4>
<p>(15 op 10,9 Rr 5,4 Rd 0)</p>
<table>
<tr><th>instructioon</th><th>function</th><th>cycle</th></tr>
<tr><td>mov Rd, Rr</td><td>Rr -> Rd</td><td>1</td></tr>
<tr><td>movw Rd, Rr</td><td>Move 16-bit (a word) Rr -> Rd Rr + 1 -> Rd + 1</td><td>1</td></tr>
</table>
</div>
<div class="generalTable">
<h4>register - > memory</h4>
<p>Data transfer between memory and register can be divided into 4 categories. 1). via the pointer register X, Y, and Z. 2). with load with address. 3). IN/OUT IO 4) push/pop</p>
<table>
<tr><th>instructioon</th><th>function</th><th>cycle</th></tr>
<tr><td>st Y, Rr</td><td>store Rr -> (Y), Y is the (r30, r31) that behave like a pointer</td><td>2</td></tr>
<tr><td>st Y+, Rr</td><td>Rr -> (Y), Y++; just leave the + sign here, e.g. st Y+, r17</td><td>2</td></tr>
<tr><td>st -Y, Rr</td><td>Y--, then store Rr -> (Y)</td><td>2</td></tr>
<tr><td>std Y+q, Rr</td><td>Rr -> (Y+q), Y does not change;; store with displacement</td><td>2</td></tr>
<tr><td>sts, k, Rr</td><td>Rr -> (k), k is 16-bit; the whole instruction is 32-bit, PC + 2</td><td>2</td></tr>
</table>
<p>This instruction also applies to X, Z register pointer, but X does not support + q, only +, no -</p>
</div>

<div class="generalTable">
<h4>memory -> register</h4>
<table>
<tr><th>instructioon</th><th>function</th><th>cycle</th></tr>
<tr><td>ld Rd, Y</td><td>load (Y) -> Rd</td><td>2</td></tr>
<tr><td>ld Rd, Y+</td><td>(Y) -> Rd, Y++</td><td>2</td></tr>
<tr><td>ld Rd, -Y</td><td>Y--, (Y) -> Rd</td><td>2</td></tr>
<tr><td>ldd Rd, Y+q</td><td>(Y+q) -> Rd</td><td>2</td></tr>
<tr><td>lds Rd, k</td><td>(k) -> Rd, k is 16-bit; the whole instruction is 32-bit, PC + 2</td><td>2</td></tr>
</table>
</div>
<div class="generalTable">
<h4>immediate - > register</h4>
<table>
<tr><th>instructioon</th><th>function</th><th>cycle</th></tr>
<tr><td>ldi Rd, K</td><td>K -> Rd; K is one byte, the whole instruction is 16-bit length</td><td>1</td></tr>
</table>
</div>
</li>
<li>
<h4>Arithmetic &amp; Logic</h4>
<p>The operands of arithmetic and logic must belong to either register or immediate. This operation will also set SREG's flag accrodingly.</p>
<div class="generalTable">
<h4>Status Register</h4>
<table>
<tr><th>Flag letter</th><th>Set condition (Flag meaning)</th></tr>
<tr><td>C</td><td>overflow</td></tr>
<tr><td>Z</td><td>result is 0</td></tr>
<tr><td>N</td><td>result is negative: the 8-bit result MSB is 1 *</td></tr>
<tr><td>V</td><td>Two's complement overflow indicator: if both operons have the same sign but result is different then set this bit</td></tr>
</table>

<p>Testing <a href="./instructions-src/test.s">source code</a> <a href="./instructions-src/Makefile">Makefile</a>
    <div class="asm" style="margin-right:300px">
    <pre>
            .equ DDRB, 0x24
            .equ PORTB, 0x25
            
            .text
                .global main
            main:
                ldi r16, 0x7f
                ldi r17, 0x01
                add r17, r16 ;; cause overflow and set N to 1
                brpl .loop; N=0 goes to infinit loop, N=1 led on
                ldi r17, 0xff
                sts DDRB,r17
                sts PORTB, r17
            
            .loop:
                jmp .loop
            
    </pre>
    </div>
</p>
<p>2's complement overflow: 
    <pre class="brush: cpp">
        unsigned char a = 255; // ldi r16, 0xff; oxff can be thought as 256 in unsigned, or -1 in two complement's
        char b = -1; // ldi r17, 0xff
        b = a + b; //  add r17, r16; the N will be set because overflow, 0xff + 0xff = 0x1fe (255 + 255 = 510)
                    //              the V will not be set because 0xff + 0xff = 0xfe (255 -1 = 254) source and result's msb is 1
        // depending how to interrupt this value, N is for unsigned, V is for signed.
        // but unsigned and signed additions use the same circuit.
    </pre>
</p>
</div>
<div class="generalTable">
<h4>ADD</h4>
<p>Flag: </p>
<table>
<tr><th>instructioon</th><th>function</th><th>cycle</th></tr>

</table>
</div>
</li>
</ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
