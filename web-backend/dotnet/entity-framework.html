<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<title>ASP.NET Core&nbsp;Entity Framework</title>
<meta charset="utf-8">
<meta name="date" content="2019-04-07">
<meta name="keywords" content="asp.net core">
<meta name="keywords" content="entity framework">
<meta name="keywords" content="database">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushPython.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />

<script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<strong>ASP.NET Core&nbsp;-&nbsp;Entity Framework</strong>
</div>
<p class="date"><span class="created-date">Created:2019-04-07</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2019-04-07</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#intro">Introduction</a></li>
<li><a href="#standalone">Run with .NET Core & ASP.NET Core as a service</a></li>
<li><a href="#indepth">In-depth</a></li>
<li><a href="#ef-tool">EF Tool</a></li>
<li><a href="#reference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="intro">
<h3>Introduction</h3>
<p>Entity Framework is a data access technology, mainly about accessing data from different database with C# language. 
    (Express's Mongoose). There are two version of Entity Framework, EF 6 and EF Core. EF Core works with .NET Core 
    and .NET Framework. So EF Core is platform and talked in this note.</p>
<div class="featureList">
    <h4>Terminology</h4>
    <ol>
        <li>Model: A class defines the mapping from C# (.NET Core) to a database entity (table schema).</li>
        <li>Context: A class that represents a database that contains multiple tables (models). An instance of a context is also a session with the database.</li>
        <li>Database provider: the actual .NET library (plug-in) allows .NET to communicate with a specific database engine. e.g. Npgsql.EntityFrameworkCore.PostgreSQL</li>
    </ol>
</div>
<div class="featureList">
    <h4>EF tool</h4>
    <p>EF tool is one of the dotnet command that faciliates database tasks. Install the tools dependency</p>
    <pre class="brush:bash">
        dotnet add package Microsoft.EntityFrameworkCore.Design
        dotnet ef -h # check help
    </pre>
</div>
</div>
</li>
<li>
    <div class="content" id="standalone">
        <h3>Run with .NET Core</h3>
        <p>Run EF Core + SQLite with .NET Core</p>
        <div class="featureList">
            <ol>
                <li>Install dependency
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Sqlite
                        dotnet add package Microsoft.EntityFrameworkCore.Design
                    </pre>
                </li>
                <li>Define model and context
                    <pre class="brush:cpp">
                            using Microsoft.EntityFrameworkCore;
                            using System.Collections.Generic;
                            using System.ComponentModel.DataAnnotations;
                            using System.ComponentModel.DataAnnotations.Schema;
                            public class TripContext : DbContext
                            {
                                public DbSet&lt;Trip> Trips { get; set; }
                                public DbSet&lt;Location> Locations { get; set; }
                                protected override void OnModelCreating(ModelBuilder modelBuilder)
                                {
                                    modelBuilder.Entity&lt;Location>()
                                        .HasKey(c => new {c.TripId, c.Count}); // this is Fluent API used to define composite key
                                }
                                protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
                                {
                                    optionsBuilder.UseSqlite("Data Source=trips.db");
                                }
                            }
                            public class Trip{
                                [Key] // using attribute to specify key. EF core only support single field key.
                                public int TripId {get; set;}
                                public string TripName {get; set;}
                            }
                            public class Location{
                                public int TripId {get; set;}
                                public int Count {get; set;}
                                public int Long {get; set;}
                                public int Lat {get; set;}
                            }
                    </pre>
                    Run
                    <pre class="brush:bash">
                        dotnet ef migrations add InitialCreate
                    </pre>
                    to scaffold the models (generate code that initialize the database)
                    <pre class="brush:bash">
                        dotnet ef database update
                    </pre>
                    apply the generated code to initialize database. (In case of using SQLite, it will generate a file .db)
                </li>
                <li>Using the database
                    <pre class="brush:cpp">
                            class Program
                            {
                                static void Main(string[] args)
                                {
                                    using (var db = new TripContext())
                                    {
                                        db.Trips.Add(new Trip { TripName = "The first trip" });
                                        int count = db.SaveChanges();
                                        Console.WriteLine("{0} records saved to database", count);
                        
                                        Console.WriteLine();
                                        Console.WriteLine("All trip in database:");
                                        foreach (Trip trip in db.Trips)
                                        {
                                            Console.WriteLine(" - {0} {1}", trip.TripId, trip.TripName);
                                        }
                                    }
                                }
                            }
                    </pre>
                </li>
                <li>Inject by ASP.NET Core Injection Container

                    <pre class="brush:cpp">
                        // register service 
                        services.AddDbContext&lt;ApplicationDbContext>(options =>
                            options.UseSqlite(
                                Configuration.GetConnectionString("DefaultConnection")));
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="featureList" id="indepth">
        <h3>In-depth</h3>
        <h4>Entity Framework Core Model</h4>
        <p>A EF Core Model is a C# class used to represent an entity in the database. It is in the conceptual layer.So 
            when creating a model, just think about creating a table with SQL. Field, fields domain, primary key, foreign key, constraints</p>
        <p>EF Core provides tools that can automatically generate and initialize the database from the developer defined Model classes.</p>
        <div class="featureList">
            <h4>Terms</h4>
            <ol>
                <li>Primary Key property: a model class's property will be set the primary key of the table.</li>
                <li>foreign key property: a model class's property whose type is the type of another model's primary key and name is {Primary}Id.</li>
                <li>Navigation property: a model class's property that a way to navigate an association between two entity types. (populate). <span style="color:red">
                        a reference object (if the multiplicity is either one or zero-or-one) or a collection (if the multiplicity is many)</span>
                    <pre class="brush:cpp">
                        public class Course
                        {
                            public int CourseID { get; set; } // primary key of the Course Table.
                            public string Title { get; set; }
                            public int Credits { get; set; }
                            public int DepartmentID { get; set; } // foregin key to Department's Id.
                            public virtual Department Department { get; set; } // an (inverse) navigation property that get a reference to Department.
                        }
                        public class Department
                        {
                            public int DepartmentID { get; set; } // primary key of the Department Table
                            public string Name { get; set; }
                            public decimal Budget { get; set; }
                            public DateTime StartDate { get; set; }
                            public int? Administrator {get ; set; }
                            public virtual ICollection&lt;Course> Courses { get; set; } // an navigation property
                        }
                    </pre>
                </li>
                <li>
                    <p>Shadow Properties: a property may not be declared in a Model class, but it will be created by <span style="color:red">the EF Core or by developer specified OnModelCreating method</span> in the database table.</p>
                    <p>In the above model, because department has a collection navigation field, Department is the principle entity and Course is the dependent entity. If course, the dependent entity, does not explicitly define the foreign key, 
                        EF Core will define a shadow foreign key for it.</p>
                </li>
                <li>one-to-many: e.g. a department has many courses.
                </li>
                <li>one-to-one: <br>
                
                </li>
            </ol>
        </div>
        <div class="featureList">
            <h4>DbContext class</h4>
            <p></p>
            <ol>
                <li>.OnModelCreating
                    <pre class="brush:cpp">
                        // create shadow properties.
                    </pre>
                </li>
            </ol>
        </div>
        <div class="featureList">
            <h4>EF Core Model Convention</h4>
            <p>EF Core defines a few conventions for mapping Model to Database Schema</p>
            <ol>
                <li>Primary Key: Exactly One primary key exists in a Model. This primary key field's name is xxxId or Id (non case-sensitive).</li>
                <li>Foreign Key: The referenced entity is called principal entity e.g. Department in the above model. By convention, a property will
                     become a foreign key if it has same type as the referenced primary id, and its name is one of<br>
                     1). {primary key} e.g. DepartmentID<br>
                     2). {principal entity}{primary key} e.g. DepartmentDepartmentID<br>
                     3). {navigation property}{primary key} e.g.<span style="color:red">?? CoursesDepartmentID or DepartmentDepartmentID    whose navigation key?? </span>
                </li>
            </ol>
        </div>
        <div class="featureList">
            <h4>EF Core Manually configure tables</h4>
            <p>Primary key, Foreign keys can be declared manually by using Attributes and FluentAPI</p>
            <h4>Attributes</h4>
            <ol>
                <li>namespace
                    <pre class="brush:cpp">
                            using System.ComponentModel.DataAnnotations;
                            using System.ComponentModel.DataAnnotations.Schema;
                    </pre>
                </li>
            </ol>
            <h4>FluentAPI</h4>
            <ol>
                <li></li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="eftool">
        <h3>EF tool</h3>
        <div class="featureList">
            <ol>
                <li><h4>Install the database providers</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Sqlite
                    </pre>
                </li>
                <li><h4>Install the ef tool</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Design
                    </pre>
                </li>
                <li><h4>Generate migration code</h4>
                    <pre class="brush:bash">
                        dotnet ef migrations add InitialCreate
                    </pre>
                </li>
                <li><h4>Apply the migration code</h4>
                    <pre class="brush:bash">
                        dotnet ef database update
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
<div class="content" id="reference">
<h3>References</h3>
<div class="featureList">
    <ol>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/" target="_blank">Entity Framework Core</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/get-started/netcore/new-db-sqlite" target="_blank">Getting Started with EF Core on .NET Core Console App with a New database</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/modeling/" target="_blank">Creating and configuring a Model</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/ef6/fundamentals/relationships" target="_blank">Relationships, navigation properties and foreign keys</a></li>
    </ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
