<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<title>ASP.NET Core&nbsp;Host</title>
<meta charset="utf-8">
<meta name="date" content="2019-03-06">
<meta name="keywords" content="">
<meta name="keywords" content="">
<meta name="keywords" content="">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />

<script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<strong>ASP.NET Core&nbsp;-&nbsp;Host</strong>
</div>
<p class="date"><span class="created-date">Created:2019-03-06</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2019-07-01</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#intro">Introduction</a></li>
<li><a href="#configuration">Host & App Configuration</a></li>
<li><a href="#startup">Startup</a></li>
<li><a href="#reference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="intro">
<h3>Introduction</h3>
<div class="featureList">
    <ol>
        <li>
            <h4>ASP.NET Core</h4>
            <p>
                When the application is runnng, the Main function will create a host instance (a container, in-process kestrel server), which is responsible for app startup,
                lifecycle management and <span style="color:red">receive http requests and create corresponding HttpContext object to invoke Application's middleware.</span> 
                And then it use the "Startup" class to configure Dependency injection, middleware and controller/MVC.
            </p>
            <p>The advantage of using the concept of Container is <span style="color:red">decoupling the web application from the server</span></p>
        </li>
        <li>
            <h4>ASP.NET Framework</h4>
            <p>ASP.NET Framework does not natively support "Startup" class and Dependency injection. Projects of ASP.NET Framework don't have a Main function, it will be compile into a library. And then it is installed into (being invoked by) IIS server to form a web app.</p>
            <p>But latter, the OWIN (Open Web Interface for .NET) defines a standard interface between web servers and .NET web applications e.g. <span style="color:red">IAppBuilder</span>, Katana is the implementation of Owin; OwinHost (in-process server), IIS Express and IIS server support 
                OWIN standard, so these server can be used with OwinStartup.</p>
        </li>
        <li>
            <h4>ASP.NET Core: Server & Container</h4>
            1). Kestrel: HTTP -> Nginx -> (Kesterl => the application code)<br>
            The default way when running a ASP.NET Core App, it is a cross-platform HTTP server implementation, so can be used on Linux, Mac OS, Windows.<br>
            2). IIS in-process hosting model: HTTP -> (IIS => IIS HTTP Server => the application code)<br>
            3). IIS out-of-process hosting model: HTTP -> IIS -> (Kesterl => the application code)<br>
        </li>
    </ol>
</div>
</div>
</li>
<li>
<div class="content" id="configuration">
    <h3>Host & App Configuration</h3>

    <p>Host (HTTP server and container) is configured before the app configuration. Both configurations are done with configuration providers.</p>
    <div class="featureList">
        <ol>
            <li>
                <h4>ASP.NET Core: launchSettings.json</h4>
                <p>launchSettings.json is generated by "dotnet new api". This file defines a list of "profiles". Each profile instructs a way 
                    (a host) to start the application and corresponding environment varaibles. <span style="color:red">** Environment variables can be defined here. **</span></p>
                
                    <pre class="brush:bash">
                        "profiles": {
                            "IIS Express": {
                              "commandName": "IISExpress",
                              "launchBrowser": true,
                              "launchUrl": "api/values",
                              "environmentVariables": {
                                "ASPNETCORE_ENVIRONMENT": "Production"
                              }
                            },
                            "kestrel": {
                              "commandName": "Project",
                              "launchBrowser": true,
                              "launchUrl": "api/values",
                              "applicationUrl": "https://localhost:5001;http://localhost:5000",
                              "environmentVariables": {
                                "ASPNETCORE_ENVIRONMENT": "Production",
                                "qinnan_cmd":"qin"
                              }
                            }
                          }
                    </pre>
                <p>If using Visual Studio, the profile will show at</p>
                <p><img src="./img/profile.png" width="400" height="200"></p>
                <p>"commandName":"Project" indicates that the project is executed with the .NET CLI directly on the command line. <a href="https://stackoverflow.com/questions/44645775/launchsettings-json-commandname-usage" target="_blank">here</a></p>
                <p>"dotnet run --launch-profile kestrel" instruct dotnet launch browser at the specified url and set environment variables.</p>
                
            </li>
            <li>
                <h4>ASP.NET Core: Host Configuration</h4>
                <p>ASP.NET Core uses Kestrel as the default web (http) server. Kestrel instance is created when calling .CreateDefaultBuilder(args);</p>
                <p>Kestrel web server helps handle HTTPS, HTTP/2. It is based on the libuv library (Node.js event-loop)</p>
                <pre class="brush:c++">
                        using Microsoft.AspNetCore;
                        using Microsoft.AspNetCore.Hosting;
                        public class Application
                        {
                            public static void Main(string[] args)
                            {
                                IWebHostBuilder hostBuilder = WebHost.CreateDefaultBuilder(args); // create a kestrel instance.
                                hostBuilder.UseStartup&lt;Startup>();
                                IWebHost host = hostBuilder.Build();
                                host.Run();
                            }
                        }
                </pre>
                <p>Inside .CreateDefaultBuilder(args), it can configure the container's (kestrel) behavior</p>
                <pre class="brush:cpp">
                    .UseKestrel()
                    ConfigureKestrel((context, options) =>
                    {
                        options.Limits.MaxRequestBodySize = 20000000; // Set properties and call methods on options
                    })
                    .UseContentRoot(Directory.GetCurrentDirectory()); // content root is the directory that contains the application content files, .GetCurrentDirectory() is the current working directory.
                </pre>
            </li>
            <li>
                    <h4>ASP.NET Core: App Configuration</h4>
                    <p>
                        App configuration is through "IConfigurationBuilder" and "IConfiguration". <span style="color:red"> *** ASP.NET used a lot of builder pattern based on C# extension.***</span>
                        IConfigurationBuilder can take a variety of sources, such as .json files, .xml files, environment variables, and command-line arguments. Moreover, it can even listen the change on 
                        configuration files.
                    </p>
                    <p>1). In the Main function
                        <pre class="brush:cpp">
                                public static void Main(string[] args)
                                {
                                    CreateWebHostBuilder(args).Build().Run();
                                }
                        
                                public static IWebHostBuilder CreateWebHostBuilder(string[] args) =>
                                    WebHost.CreateDefaultBuilder(args)
                                        .ConfigureAppConfiguration((context, configBuilder)=>{
                                            # context

                                            # config is a IConfigurationBuilder object, it have a lot of extension methods to include a variety of config sources.
                                            configBuilder.AddEnvironmentVariables(prefix:"qinnan_");
                                            configBuilder.AddCommandLine(args);
                                        })
                                        .UseStartup&lt;Startup>();

                            </pre>
                            After that, the webhost calls
                            <pre class="brush:cpp">
                                IConfiguration config = configBuilder.Build();
                            </pre>
                            to obtain the IConfiguration object, and gives it to "Startup" class.
                        </p>
                        <p>
                            2). WebHost's default builder behavior: loading configuration from 
                            <pre class="brush:bash">
                                appsettings.json,
                                environment variables, 
                                command line arguments,
                            </pre>
                        </p>
                </li>
                <li><h4>Environment variables</h4>
                    It is usually specified as an environment variable in the launch profile.
                    Host use this value to configure its logging behavior.
                </li>

                <li><h4>IConfiguration</h4>
                    <pre class="brush:cpp">
        public Startup(IConfiguration configuration)
        {
            Configuration = configuration;
            Console.WriteLine("## App Configuration[Logging:Loglevel:default] " + configuration["Logging:loglevel:default"]);
            Console.WriteLine("## App Configuration[applicationUrl] " + configuration["applicationUrl"]);
            Console.WriteLine("## command-line cmd = " + configuration["cmd"]);
        }
                    </pre>
                    <p>.json configuration's hierachary is kept with ":"</p>
                    <p>command-line configuration is given by "dotnet run --cmd command-value"</p>
                    <p>environment variables are set by launchSettings.json</p>
                    <h4>Add customized configuration</h4>
                    <pre class="brush:cpp">
                        WebHost.CreateDefaultBuilder(args)
                        .ConfigureAppConfiguration((hostingContext, config) =>
                        {
                            config.SetBasePath(Directory.GetCurrentDirectory());
                            config.AddInMemoryCollection(arrayDict);
                            config.AddJsonFile("json_array.json", optional: false, reloadOnChange: false);
                            config.AddJsonFile("starship.json", optional: false, reloadOnChange: false);
                            config.AddXmlFile("tvshow.xml", optional: false, reloadOnChange: false);
                            config.AddEFConfiguration(options => options.UseInMemoryDatabase("InMemoryDb"));
                            config.AddCommandLine(args);
                        })
                        .UseStartup&lt;Startup>();
                    </pre>
                </li>
                
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="startup">
        <h3>Startup</h3>
        <h4>ASP.NET Core: Startup</h4>
        <div class="featureList">
            <ol>
                <li><h4>Microsoft.AspNetCore.Hosting Startup</h4>
                    <p>ASP.NET Core natively integrates the Kestrel in-process server and supports the Startup class.
                        Startup class has 3 methods, constructor, ConfigureServices: inject dependencies, Configure: configuring app (add routing, controller...)
                    </p>
                    <pre class="brush:cpp">
                    public class Startup{
                        public Startup(IConfiguration configuration, ILogger<Startup> logger, IHostingEnvironment env)
                        {
                            Configuration = configuration;
                            _logger = logger;
                            _logger.LogInformation("Startup Constructor is Called");
                            this.env = env;

                        }

                        public IConfiguration Configuration { get; }
                        private readonly ILogger _logger;
                        private readonly IHostingEnvironment env;

                        // This method gets called by the runtime. Use this method to add services to the container.
                        public IServiceProvider ConfigureServices(IServiceCollection services)
                        {
                            services.AddScoped&lt;IMyService, MyService>();
                            services.AddSingleton&lt;Startup>(this);
                            services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_2);
                            IServiceProvider sp = services.BuildServiceProvider();
                            return sp;
                        }

                        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
                        public void Configure(IApplicationBuilder app)
                        {
                            app.UseMvc();
                        }
                     </pre>
                     <h4>Startup Detection</h4>
                     <p>
                         1). using Main.<br>
                         2). following convention<br>
                         3). implementment IStartup
                     </p>
                        Developer defines a Startup class that either follow's convention or implement the IStartup interface.<br>
                        1). IStartup: If asp.net detected the implementation of IStartup, it will register the (IStartup, Startup) pair to the service container.<br>
                        2). <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/startup?view=aspnetcore-2.2#the-startup-class" target="_blank">Convention</a>: Startup is not registered. But inside its member functions,
                         e.g. ConfigureServices and Configure, their parameters can include any registered services, not restricted by the interface.
                </li>
            </ol>
        </div>
        <h4>ASP.NET Framework: Startup</h4>
        <p>ASP.NET Framework does not natively support Startup class, it is achieved by using <span style="color:red">Microsoft.Owin.Host.SystemWeb</span>. Download this package from NuGet (current version is 4.0.1)</p>
        <div class="featureList">
            <ol>
                <li>
                    <h4>Owin Startup</h4>
                    <p>Add the following Startup.cs manually or through Visual Studio's Add Item.</p>
                    <pre class="brush:cpp">
            using System;
            using System.Threading.Tasks;
            using Microsoft.Owin;
            using Owin;
            
            [assembly: OwinStartup(typeof(owin_startup_practice.Startup))]
            
            namespace owin_startup_practice
            {
                public class Startup
                {
                    public void Configuration(IAppBuilder app)
                    {
                        // For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=316888
                    }
                }
            }
                    </pre>
                    <p>
                        Compare to ASP.NET Core's startup, <br>
                        1). OWIN startup does not have a "ConfigureServices" method, which means OWIN itself does not support Dependency Injection, has to use 3rd party modules, like Autofac or Ninject.
                        <br>
                        2). OWIN startup does not have "Configuration" properties, which means Configuration is also need 3rd party library or using System.Configuration library.
                    </p>
                    <p>Both ASP.NET Core native startup and Owin starup use the concept of "pipeline of middleware".</p>
                    <h4>Detection of Owin Startup class</h4>
                    <p>1). Mark the Startup class with attribute:[assembly: OwinStartup(typeof(owin_startup_practice.Startup))]<br>
                        2). A class named Startup in the global namespace (global namesapce: without a namespace.)
                    </p>
                </li>
                <li>
                    <h4>Self-host OWIN</h4>
                    <p>The default OWIN project is output as a .dll library and then invoked by IIS server or IIS Express. But OWIN also provides a Kestrel like in-process host (container), Owin.SelfHost</p>
                    <p>Install <span style="color:red">Microsoft.Owin.SelfHost</span> (curren version v4.0.1)</p>
                    <pre class="brush:cpp">
                        using System;
                        using System.Collections.Generic;
                        using System.Linq;
                        using System.Web;
                        using Microsoft.Owin.Hosting;
                        namespace owin_startup_practice
                        {
                            public class Program
                            {
                                public static void Main(string[] args) {
                                    using (WebApp.Start&lt;Startup>("http://locahost:12000")) {
                                        Console.WriteLine("Press [enter] to quit ...");
                                        Console.ReadLine();
                                    }
                                }
                            }
                        }
                    </pre>
                    <p>The selfhost is configurable,like desingating a url.</p>
                </li>
            </ol>
        </div>

    </div>
</li>
<li>
<div class="content" id="reference">
<h3>References</h3>
<div class="featureList">
    <ol>
        <li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-2.2#how-to-use-kestrel-in-aspnet-core-apps" target="_blank">How to use Kestrel in ASP.NET Core apps</a></li>
        <li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.webhost.createdefaultbuilder?view=aspnetcore-2.2" target="_blank">WebHost.CreateDefaultBuilder Method</a></li>
        <li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-2.2#kestrel-options" target="_blank">Kestrel Options</a></li>
        <li><a href="https://www.talkingdotnet.com/launchsetting-json-in-aspnet-5/" target="_blank">What is launchsetting.json in ASP.NET Core</a></li>
        <li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-2.2" target="_blank">Configuration in ASP.NET Core</a></li>
        <li><a href="https://docs.microsoft.com/en-us/aspnet/aspnet/overview/owin-and-katana/getting-started-with-owin-and-katana" target="_blank">Getting Started with OWIN and Katana</a></li>
        <li><a href="https://docs.microsoft.com/en-us/aspnet/aspnet/overview/owin-and-katana/owin-startup-class-detection#owin-startup-class-detection-1" target="_blank">OWIN Startup Class Detection</a></li>
    </ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
