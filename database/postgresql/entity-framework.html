<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<title>Database&nbsp;Entity Framework</title>
<meta charset="utf-8">
<meta name="date" content="2019-04-07">
<meta name="keywords" content="asp.net core">
<meta name="keywords" content="entity framework">
<meta name="keywords" content="database">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushPython.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushSql.js"></script>

<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />

<script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<strong>Database&nbsp;-&nbsp;Entity Framework</strong>
</div>
<p class="date"><span class="created-date">Created:2019-04-07</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2019-06-28</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#intro">Introduction</a></li>
<li><a href="#code-first">Code-first approach with SQLite</a></li>
<li><a href="#database-first">Database-first approach with PostgreSQL</a></li>
<li><a href="#indepth">In-depth</a></li>
<li><a href="#ef-tool">EF Tool</a></li>
<li><a href="#reference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="intro">
<h3>Introduction</h3>
<p>Entity Framework is a data access technology, mainly about accessing data from different database with C# language. 
    (Express's Mongoose). There are two version of Entity Framework, EF 6 and EF Core. EF Core is the EF of .NET Core version; 
    EF 6 is the EF of .NET Framework. This note used EF Core as an example.</p>
<div class="featureList">
    <h4>Terminology</h4>
    <ol>
        <li>Model: A class defines the mapping from C# (.NET Core) to a database entity (table schema).</li>
        <li>Context: A class that represents a database that contains multiple tables (models). An instance of a context is also a session with the database.</li>
        <li>Database provider: the actual .NET library (plug-in) allows .NET to communicate with a specific database engine. e.g. Npgsql.EntityFrameworkCore.PostgreSQL</li>
    </ol>
</div>
<div class="featureList">
    <h4>EF tool</h4>
    <p>When installing dotnet, it also includes a sub-command called dotnet ef. It faciliates database tasks. Install the tools dependency</p>
    <pre class="brush:bash">
        dotnet add package Microsoft.EntityFrameworkCore.Design
        dotnet ef -h # check help
    </pre>
    <p>With this library, ef tool can help generate C# model from a well-defined database (database-first approach), or generate database from a well-defined C# model (code-first approach).</p>
</div>
</div>
</li>
<li>
    <div class="content" id="standalone">
        <h3>Code-first approach with SQLite</h3>
        <div class="featureList">
            <ol>
                <li>Install dependency
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Sqlite # sqlite provider
                        dotnet add package Microsoft.EntityFrameworkCore.Design 
                    </pre>
                </li>
                <li>Define model and context
                    <pre class="brush:cpp">
                            using Microsoft.EntityFrameworkCore;
                            using System.Collections.Generic;
                            using System.ComponentModel.DataAnnotations;
                            using System.ComponentModel.DataAnnotations.Schema;
                            public class TripContext : DbContext
                            {
                                public DbSet&lt;Trip> Trips { get; set; }
                                public DbSet&lt;Location> Locations { get; set; }
                                protected override void OnModelCreating(ModelBuilder modelBuilder)
                                {
                                    modelBuilder.Entity&lt;Location>()
                                        .HasKey(c => new {c.TripId, c.Count}); // this is Fluent API used to define composite key
                                }
                                protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
                                {
                                    optionsBuilder.UseSqlite("Data Source=trips.db");
                                }
                            }
                            public class Trip{
                                [Key] // using attribute to specify key. EF core only support single field key.
                                public int TripId {get; set;}
                                public string TripName {get; set;}
                            }
                            public class Location{
                                public int TripId {get; set;}
                                public int Count {get; set;}
                                public int Long {get; set;}
                                public int Lat {get; set;}
                            }
                    </pre>
                    Run
                    <pre class="brush:bash">
                        # scaffold the models (generate code that initialize the database)
                        dotnet ef migrations add InitialCreate
                        # apply the generated code to initialize database. (In case of using SQLite, it will generate a file .db)
                        dotnet ef database update      
                    </pre>
                </li>
                <li>Using the database
                    <pre class="brush:cpp">
                            class Program
                            {
                                static void Main(string[] args)
                                {
                                    using (var db = new TripContext())
                                    {
                                        db.Trips.Add(new Trip { TripName = "The first trip" });
                                        int count = db.SaveChanges();
                                        Console.WriteLine("{0} records saved to database", count);
                        
                                        Console.WriteLine();
                                        Console.WriteLine("All trip in database:");
                                        foreach (Trip trip in db.Trips)
                                        {
                                            Console.WriteLine(" - {0} {1}", trip.TripId, trip.TripName);
                                        }
                                    }
                                }
                            }
                    </pre>
                </li>
                <li>Inject by ASP.NET Core Injection Container
                    <pre class="brush:cpp">
                        // register service 
                        services.AddDbContext&lt;ApplicationDbContext>(options =>
                            options.UseSqlite(
                                Configuration.GetConnectionString("DefaultConnection")));
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="database-first">
        <h3>Database-first approach with PostgreSQL</h3>
        <p>Restoring database from the <a href="http://www.postgresqltutorial.com/postgresql-sample-database/" target="_blank">dvdrental example.</a> <a href="./db-sample/dvdrental.tar">Download</a></p>
        <div class="featureList">
            <ol>
                <li>
                    <h4>Install dependencies</h4>
                    <p> *** Keep the major version of dotnet core, ef tool, and provider same.</p>
                    <pre class="brush:bash">
                            # npgsql 2.2 supports ef 2.2
                            dotnet add package Microsoft.EntityFrameworkCore.Design --version=2.2.0 
                            dotnet ad package Npgsql.EntityFrameworkCore.PostgreSQL --version=2.2.0 # provider
                    </pre>
                </li>
                <li><h4>Connection string</h4>
                <p>Each database server has its own connection string format. There also exist different proposes connection string<br>
                    e.g.1).  standard security: connect with username + password<br>
                        2).  trusted connection: connection is verified with domain.<br>
                </p>
                <p>Example (case-insensitive):<br>
                    1).SQL Server standard: Server=localhost;Database=dvdrental;User Id=myUsername; Password=myPassword;<br>
                    2).SQL Server trusted connection: Server=localhost;Database=dvdrental;trusted_connection=true;<br>
                    3).PostgreSQL standard: Host=localhost;Database=dvdrental;Username=postgres;Password=password
                </p>
                </li>
                <li>
                    <h4>Generate C# models</h4>
                    <pre class="brush:bash">
                        # from a PostgreSQL database
                        dotnet ef dbcontext scaffold "Host=localhost;Database=dvdrental;Username=postgres;Password=password" Npgsql.EntityFrameworkCore.PostgreSQL -o Models
                        # from a SQL Server database with specifying a specific schema and output json format of generated files.
                        dotnet ef dbcontext scaffold "Server=localhost;Database=dvdrental;trusted_connection=true;" Microsoft.EntityFrameworkCore.SqlServer --output-dir Models.Configuration --schema Configuration --json
                        # generate entity class for specified tables.
                        dotnet ef dbcontext scaffold \
                            "Server=devdb.kabbage.com;Database=koltpweb;trusted_connection=true;" Microsoft.EntityFrameworkCore.SqlServer
                            --output-dir Models \
                            --table ACH.Account \
                            --table ACH.FedACHDirectory \
                            --json
                        # the entity class name is same as table name, so if two schames have tables with same name, then ... [some entities will not be generated.]
                    </pre>
                    <p>** When generating dvdrental from postgrestutorial.com, the imported database set primary key as integer, but foreign key as smallint. So before running the above command, using pgAdmin modifies the foreign key to integer type.</p>
                </li>
                <li>
                    <h4>PostgreSQL enum type</h4>
                    <p>PostgreSQL can define enum. As the user's prespective, enum is like string, but the underlying storage is int.</p>
                    <p>But in C# model, we have to manually define the enum type and add the attribute to C# model.</p>
                    <pre class="brush:sql">
                            -- example of SQL defined enum type.
                            CREATE TYPE public.mpaa_rating AS ENUM
                            ('G', 'PG', 'PG-13', 'R', 'NC-17');                        
                    </pre>
                    <pre style="border:1px solid green;border-radius:15px; width:600px; padding:10px;">Enum flow
                        C# Enum Rating.PG13;
                        -- C# convert function --
                        C# string 'PG-13'
                        -- dbContext --
                        postgreSQL enum 'PG-13'
                        postgreSQL underlying storage 1

                    </pre>
                    Define the C# enum and converting class.
                    <pre class="brush:cpp">
                            
                            public enum Rating{
                                G, 
                                PG, 
                                PG13, 
                                R, 
                                NC17 
                           }
                           public static class RatingConverter{
                               public static Rating ToEnum(string rating){
                                   switch(rating){
                                       case "G": return Rating.G;
                                       case "PG": return Rating.PG;
                                       case "PG-13": return Rating.PG13;
                                       case "R": return Rating.R;
                                       default: return Rating.NC17;
                                   }
                               }
                               public static string ToString(Rating r){
                                   switch(r){
                                       case Rating.G: return "G";
                                       case Rating.PG: return "PG";
                                       case Rating.PG13: return "PG-13";
                                       case Rating.R: return "R";
                                       default: return "NC-17";
                                   }
                               }
                               public static ValueConverter&lt;Rating, string> GetConverter(){
                                   return new ValueConverter&lt;Rating, string>(
                                       r => ToString(r),
                                       s => ToEnum(s)
                                   );
                               }
                           }
                    </pre>
                    Add the rating attribute to Model
                    <pre class="brush:cpp">
                        // ...
                        public Rating Rating {get; set;}
                        // ...
                    </pre>
                    Register value converter under OnModelCreating
                    <pre class="brush:cpp">
                        entity.Property( e=> e.Rating)
                            .HasColumnName("rating")
                            .HasConversion(RatingConverter.GetConverter());
                    </pre>
                </li>
                <li>
                    <h4>Using the context</h4>
                    <pre class="brush:cpp">
                            dvdrentalContext _context = new dvdrentalContext();
                            foreach (var item in _context.Film)
                            {
                                Console.WriteLine("{0} | {1}", item.Title, item.Rating);
                            }
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="indepth">
        <h3>In-depth</h3>
        <h4>Entity Framework Core Model</h4>
        <p>A EF Core Model is a C# class used to represent an entity in the database. It is in the conceptual layer.So 
            when creating a model, just think about creating a table with SQL. Field, fields domain, primary key, foreign key, constraints</p>
        <h4>Fluent API</h4>
        <p>In EF Core, the configuration of each entity is done in the Context class's OnConfiguring method<br>
            In EF Framework, the each entity has a Configuration class to do configuration e.g.
            <pre class="brush:cpp">
                public class LU_CarType{
                    // ...
                }
                public class LU_CarTypeConfiguration : System.Data.Entity.ModelConfiguration.EntityTypeConfiguration&lt;LU_CarType>{
                    public Configuration_FinancialInstitutionConfiguration()
                        : this("Schema_Name")
                    {
                    }

                    public LU_CarTypeConfiguration(string schema)
                    {
                        //...
                    }
                }
            </pre>
            Configuration includes:<br>
            1). set primary key,<br>
            2). map c# properties to table column. mark constraints e.g. not not == .isRequired() and type
            3). relationship across table.
            <p style="color:red">This set of API is called Fluent API.</p>
        </p>
        <div class="featureList">
            <h4>Fluent API</h4>
            <ol>
                <li>Primary Key property: a model class's property will be set the primary key of the table.</li>
                <li>foreign key properties: a model class's property whose type is the type of another model's primary key and name is {Primary}Id.</li>
                <li>Navigation property: a model class's property that a way to navigate an association between two entity types. (populate). <span style="color:red">
                        a reference object (if the multiplicity is either one or zero-or-one) or a collection (if the multiplicity is many)</span>
                    <pre class="brush:cpp">
                        public class Course
                        {
                            public int CourseID { get; set; } // primary key of the Course Table.
                            public string Title { get; set; }
                            public int Credits { get; set; }
                            public int DepartmentID { get; set; } // foregin key to Department's Id.
                            public virtual Department Department { get; set; } // an (inverse) navigation property that get a reference to Department.
                        }
                        public class Department
                        {
                            public int DepartmentID { get; set; } // primary key of the Department Table
                            public string Name { get; set; }
                            public decimal Budget { get; set; }
                            public DateTime StartDate { get; set; }
                            public int? Administrator {get ; set; }
                            public virtual ICollection&lt;Course> Courses { get; set; } // an navigation property
                        }
                    </pre>
                </li>
                <li>
                    <p>Shadow Properties: a property may not be declared in a Model class, but it will be created by <span style="color:red">the EF Core or by developer specified OnModelCreating method</span> in the database table.</p>
                    <p>In the above model, because department has a collection navigation field, Department is the principle entity and Course is the dependent entity. If course, the dependent entity, does not explicitly define the foreign key, 
                        EF Core will define a shadow foreign key for it.</p>
                </li>
                <li>one-to-many: e.g. a department has many courses.
                </li>
                <li>one-to-one: <br>
                
                </li>
                <li>
                    <h4>Naming convention</h4>
                </li>
            </ol>
        </div>
        <div class="featureList">
            <h4>DbContext class</h4>
            <p></p>
            <ol>
                <li>.OnModelCreating
                    <pre class="brush:cpp">
                        // create shadow properties.
                    </pre>
                </li>
            </ol>
        </div>
        <div class="featureList">
            <h4>EF Core Model Convention</h4>
            <p>EF Core defines a few conventions for mapping Model to Database Schema</p>
            <ol>
                <li>Primary Key: Exactly One primary key exists in a Model. This primary key field's name is xxxId or Id (non case-sensitive).</li>
                <li>Foreign Key: The referenced entity is called principal entity e.g. Department in the above model. By convention, a property will
                     become a foreign key if it has same type as the referenced primary id, and its name is one of<br>
                     1). {primary key} e.g. DepartmentID<br>
                     2). {principal entity}{primary key} e.g. DepartmentDepartmentID<br>
                     3). {navigation property}{primary key} e.g.<span style="color:red">?? CoursesDepartmentID or DepartmentDepartmentID    whose navigation key?? </span>
                </li>
            </ol>
        </div>
        <div class="featureList">
            <h4>EF Core Manually configure tables</h4>
            <p>Primary key, Foreign keys can be declared manually by using Attributes and FluentAPI</p>
            <h4>Attributes</h4>
            <ol>
                <li>namespace
                    <pre class="brush:cpp">
                            using System.ComponentModel.DataAnnotations;
                            using System.ComponentModel.DataAnnotations.Schema;
                    </pre>
                </li>
            </ol>
            <h4>FluentAPI</h4>
            <ol>
                <li></li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="eftool">
        <h3>EF tool</h3>
        <div class="featureList">
            <ol>
                <li><h4>Install the database providers</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Sqlite
                    </pre>
                </li>
                <li><h4>Install the ef tool</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Design
                    </pre>
                </li>
                <li><h4>Generate migration code</h4>
                    <pre class="brush:bash">
                        dotnet ef migrations add InitialCreate
                    </pre>
                </li>
                <li><h4>Apply the migration code</h4>
                    <pre class="brush:bash">
                        dotnet ef database update
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
<div class="content" id="reference">
<h3>References</h3>
<div class="featureList">
    <ol>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/" target="_blank">Entity Framework Core</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/get-started/netcore/new-db-sqlite" target="_blank">Getting Started with EF Core on .NET Core Console App with a New database</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/modeling/" target="_blank">Creating and configuring a Model</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/ef6/fundamentals/relationships" target="_blank">Relationships, navigation properties and foreign keys</a></li>
    </ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
