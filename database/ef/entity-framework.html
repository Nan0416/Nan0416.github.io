<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<title>Database&nbsp;Entity Framework</title>
<meta charset="utf-8">
<meta name="date" content="2019-04-07">
<meta name="keywords" content="asp.net core">
<meta name="keywords" content="entity framework">
<meta name="keywords" content="database">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushPython.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushSql.js"></script>

<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />

<script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<strong>Database&nbsp;-&nbsp;Entity Framework</strong>
</div>
<p class="date"><span class="created-date">Created:2019-04-07</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2019-06-28</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#intro">Introduction</a></li>
<li><a href="#code-first">Code-first approach with SQLite</a></li>
<li><a href="#database-first">Database-first approach with PostgreSQL</a></li>
<li><a href="#indepth">In-depth</a></li>
<!--<li><a href="#ef-tool">EF Tool</a></li>-->
<li><a href="#reference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="intro">
<h3>Introduction</h3>
<p>Entity Framework is a data access technology, mainly about accessing data from different database with C# language. 
    (Express's Mongoose). There are two version of Entity Framework, EF 6 and EF Core. EF Core is the EF of .NET Core version; 
    EF 6 is the EF of .NET Framework. This note used EF Core as an example.</p>
<div class="featureList">
    <h4>Terminology</h4>
    <ol>
        <li>Model: A class defines the mapping from C# (.NET Core) to a database entity (table schema).</li>
        <li>Context: A class that represents a database that contains multiple tables (models). An instance of a context is also a session with the database.</li>
        <li>Database provider: the actual .NET library (plug-in) allows .NET to communicate with a specific database engine. e.g. Npgsql.EntityFrameworkCore.PostgreSQL</li>
    </ol>
</div>
<div class="featureList">
    <h4>EF tool</h4>
    <p>When installing dotnet, it also includes a sub-command called dotnet ef. It faciliates database tasks. Install the tools dependency</p>
    <pre class="brush:bash">
        dotnet add package Microsoft.EntityFrameworkCore.Design
        dotnet ef -h # check help
    </pre>
    <p>With this library, ef tool can help generate C# model from a well-defined database (database-first approach), or generate database from a well-defined C# model (code-first approach).</p>
</div>
</div>
</li>
<li>
    <div class="content" id="code-first">
        <h3>Code-first approach with SQLite</h3>
        <div class="featureList">
            <ol>
                <li>Install dependency
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Sqlite # sqlite provider
                        dotnet add package Microsoft.EntityFrameworkCore.Design 
                    </pre>
                </li>
                <li>Define model and context
                    <pre class="brush:cpp">
                            using Microsoft.EntityFrameworkCore;
                            using System.Collections.Generic;
                            using System.ComponentModel.DataAnnotations;
                            using System.ComponentModel.DataAnnotations.Schema;
                            public class TripContext : DbContext
                            {
                                public DbSet&lt;Trip> Trips { get; set; }
                                public DbSet&lt;Location> Locations { get; set; }
                                protected override void OnModelCreating(ModelBuilder modelBuilder)
                                {
                                    modelBuilder.Entity&lt;Location>()
                                        .HasKey(c => new {c.TripId, c.Count}); // this is Fluent API used to define composite key
                                }
                                protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
                                {
                                    optionsBuilder.UseSqlite("Data Source=trips.db");
                                }
                            }
                            public class Trip{
                                [Key] // using attribute to specify key. EF core only support single field key.
                                public int TripId {get; set;}
                                public string TripName {get; set;}
                            }
                            public class Location{
                                public int TripId {get; set;}
                                public int Count {get; set;}
                                public int Long {get; set;}
                                public int Lat {get; set;}
                            }
                    </pre>
                    Run
                    <pre class="brush:bash">
                        # scaffold the models (generate code that initialize the database)
                        dotnet ef migrations add InitialCreate
                        # apply the generated code to initialize database. (In case of using SQLite, it will generate a file .db)
                        dotnet ef database update      
                    </pre>
                </li>
                <li>Using the database
                    <pre class="brush:cpp">
                            class Program
                            {
                                static void Main(string[] args)
                                {
                                    using (var db = new TripContext())
                                    {
                                        db.Trips.Add(new Trip { TripName = "The first trip" });
                                        int count = db.SaveChanges();
                                        Console.WriteLine("{0} records saved to database", count);
                        
                                        Console.WriteLine();
                                        Console.WriteLine("All trip in database:");
                                        foreach (Trip trip in db.Trips)
                                        {
                                            Console.WriteLine(" - {0} {1}", trip.TripId, trip.TripName);
                                        }
                                    }
                                }
                            }
                    </pre>
                </li>
                <li>Inject by ASP.NET Core Injection Container
                    <pre class="brush:cpp">
                        // register service 
                        services.AddDbContext&lt;ApplicationDbContext>(options =>
                            options.UseSqlite(
                                Configuration.GetConnectionString("DefaultConnection")));
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="database-first">
        <h3>Database-first approach with PostgreSQL</h3>
        <p>Restoring database from the <a href="http://www.postgresqltutorial.com/postgresql-sample-database/" target="_blank">dvdrental example.</a> <a href="./db-sample/dvdrental.tar">Download</a></p>
        <div class="featureList">
            <ol>
                <li>
                    <h4>Install dependencies</h4>
                    <p> *** Keep the major version of dotnet core, ef tool, and provider same.</p>
                    <pre class="brush:bash">
                            # npgsql 2.2 supports ef 2.2
                            dotnet add package Microsoft.EntityFrameworkCore.Design --version=2.2.0 
                            dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL --version=2.2.0 # provider
                    </pre>
                </li>
                <li><h4>Connection string</h4>
                <p>Each database server has its own connection string format. There also exist different proposes connection string<br>
                    e.g.1).  standard security: connect with username + password<br>
                        2).  trusted connection: connection is verified with domain.<br>
                </p>
                <p>Example (case-insensitive):<br>
                    1).SQL Server standard: Server=localhost;Database=dvdrental;User Id=myUsername; Password=myPassword;<br>
                    2).SQL Server trusted connection: Server=localhost;Database=dvdrental;trusted_connection=true;<br>
                    3).PostgreSQL standard: Host=localhost;Database=dvdrental;Username=postgres;Password=password
                </p>
                </li>
                <li>
                    <h4>Generate C# models</h4>
                    <pre class="brush:bash">
                        # from a PostgreSQL database
                        dotnet ef dbcontext scaffold "Host=localhost;Database=dvdrental;Username=postgres;Password=password" Npgsql.EntityFrameworkCore.PostgreSQL -o Models
                        # from a SQL Server database with specifying a specific schema and output json format of generated files.
                        dotnet ef dbcontext scaffold "Server=localhost;Database=dvdrental;trusted_connection=true;" Microsoft.EntityFrameworkCore.SqlServer --output-dir Models.Configuration --schema Configuration --json
                        # generate entity class for specified tables.
                        dotnet ef dbcontext scaffold \
                            "Server=localhost;Database=dvdrental;trusted_connection=true;" Microsoft.EntityFrameworkCore.SqlServer
                            --output-dir Models \
                            --table public.actor \
                            --table public.film \
                            --json
                        # the entity class name is same as table name, so if two schames have tables with same name, then ... [some entities will not be generated.]
                    </pre>
                    <p>** When generating dvdrental from postgrestutorial.com, the imported database set primary key as integer, but foreign key as smallint. So before running the above command, using pgAdmin modifies the foreign key to integer type.</p>
                </li>
                <li>
                    <h4>PostgreSQL enum type</h4>
                    <p>PostgreSQL supports enum (SQL server doesn't). As the user's prespective, enum is like string, but the underlying storage is int.</p>
                    <p>But in C# model, we have to manually define the enum type and add the attribute to C# model.</p>
                    <pre class="brush:sql">
                            -- example of SQL defined enum type.
                            CREATE TYPE public.mpaa_rating AS ENUM
                            ('G', 'PG', 'PG-13', 'R', 'NC-17');                        
                    </pre>
                    <pre style="border:1px solid green;border-radius:15px; width:600px; padding:10px;">Enum flow
                        C# Enum Rating.PG13;
                        -- C# convert function --
                        C# string 'PG-13'
                        -- dbContext --
                        postgreSQL enum 'PG-13'
                        postgreSQL underlying storage 1

                    </pre>
                    Define the C# enum and converting class.
                    <pre class="brush:cpp">
                            
                            public enum Rating{
                                G, 
                                PG, 
                                PG13, 
                                R, 
                                NC17 
                           }
                           public static class RatingConverter{
                               public static Rating ToEnum(string rating){
                                   switch(rating){
                                       case "G": return Rating.G;
                                       case "PG": return Rating.PG;
                                       case "PG-13": return Rating.PG13;
                                       case "R": return Rating.R;
                                       default: return Rating.NC17;
                                   }
                               }
                               public static string ToString(Rating r){
                                   switch(r){
                                       case Rating.G: return "G";
                                       case Rating.PG: return "PG";
                                       case Rating.PG13: return "PG-13";
                                       case Rating.R: return "R";
                                       default: return "NC-17";
                                   }
                               }
                               public static ValueConverter&lt;Rating, string> GetConverter(){
                                   return new ValueConverter&lt;Rating, string>(
                                       r => ToString(r),
                                       s => ToEnum(s)
                                   );
                               }
                           }
                    </pre>
                    Add the rating attribute to Model
                    <pre class="brush:cpp">
                        // ...
                        public Rating Rating {get; set;}
                        // ...
                    </pre>
                    Register value converter under OnModelCreating
                    <pre class="brush:cpp">
                        entity.Property( e=> e.Rating)
                            .HasColumnName("rating")
                            .HasConversion(RatingConverter.GetConverter());
                    </pre>
                </li>
                <li>
                    <h4>Using the context</h4>
                    <pre class="brush:cpp">
                            dvdrentalContext _context = new dvdrentalContext();
                            foreach (var item in _context.Film)
                            {
                                Console.WriteLine("{0} | {1}", item.Title, item.Rating);
                            }
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="indepth">
        <h3>In-depth</h3>
        <h4>Entity Framework Core Model</h4>
        <p>A EF Core Model is a C# class used to represent an entity in the database. It is in the conceptual layer.So 
            when creating a model, just think about creating a table with SQL. Field, fields domain, primary key, foreign key, constraints</p>
        <h4>Fluent API</h4>
        <p>Fluent API: configure C# Model (entity) to map to database field, type and constraints. It is important when using code-first approach because they instruct EF Core to create database.</p>
        <div class="featureList">
            <ol>
                <li>
                    <h4>Model/Entity class (EF Core example)</h4>
                    <p>film: primary key (film_id), foreign keys (language_id -> language.language_id)<br><br>
                        film_actor: film_id -> film.film_id<br>
                        film_category: film_id -> film.film_id<br>
                        inventory: film_id -> film.film_id
                    </p>
                    <pre class="brush:sql">
                            CREATE TABLE public.film
                            (
                                film_id integer NOT NULL DEFAULT nextval('film_film_id_seq'::regclass),
                                title character varying(255) COLLATE pg_catalog."default" NOT NULL,
                                description text COLLATE pg_catalog."default",
                                release_year year,
                                language_id integer NOT NULL,
                                rental_duration smallint NOT NULL DEFAULT 3,
                                rental_rate numeric(4,2) NOT NULL DEFAULT 4.99,
                                length smallint,
                                replacement_cost numeric(5,2) NOT NULL DEFAULT 19.99,
                                rating mpaa_rating DEFAULT 'G'::mpaa_rating,
                                last_update timestamp without time zone NOT NULL DEFAULT now(),
                                special_features text[] COLLATE pg_catalog."default",
                                fulltext tsvector NOT NULL,
                                CONSTRAINT film_pkey PRIMARY KEY (film_id),
                                CONSTRAINT film_language_id_fkey FOREIGN KEY (language_id)
                                    REFERENCES public.language (language_id) MATCH SIMPLE
                                    ON UPDATE CASCADE
                                    ON DELETE RESTRICT
                            );
                    </pre>
                    <pre class="brush:cpp">
                            public partial class Film
                            {
                                public Film()
                                {
                                    // other entities refer to film. 
                                    // one film -- many others.
                                    FilmActor = new HashSet&lt;FilmActor>();
                                    FilmCategory = new HashSet&lt;FilmCategory>();
                                    Inventory = new HashSet&lt;Inventory>();
                                }

                                    public int FilmId { get; set; }
                                    public string Title { get; set; }
                                    public string Description { get; set; }
                                    public int? ReleaseYear { get; set; }
                                    public int LanguageId { get; set; }
                                    public short RentalDuration { get; set; }
                                    public decimal RentalRate { get; set; }
                                    public short? Length { get; set; }
                                    public decimal ReplacementCost { get; set; }
                                    public Rating Rating {get; set;}
                                    public DateTime LastUpdate { get; set; }
                                    public string[] SpecialFeatures { get; set; }
                                    public NpgsqlTsVector Fulltext { get; set; }

                                    public virtual Language Language { get; set; } // many film : one language

                                    public virtual ICollection&lt;FilmActor> FilmActor { get; set; } // one film : many filmActor
                                    public virtual ICollection&lt;FilmCategory> FilmCategory { get; set; } // one film: many FilmCategory
                                    public virtual ICollection&lt;Inventory> Inventory { get; set; } // one film: many inventory
                                }
                    </pre>
                    <p>Shadow Properties: a property may not be declared in a Model class, but it will be created by the EF Core or by developer specified OnModelCreating method in the database table.<br>
                    .e.g. A "LastUpdate" may add to a database but it is not defined in db entity class and never used.
                    </p>
                </li>
                <li>
                    <h4>DbContext Configuration</h4>
                    <p>DbContext is initialized before using a database or generating a database from code.</p>
                    <p><span style="color:green">EF Core configuring a DbContext</span><br>
                    A DbContext is initialized with a 'DbContextOptions' object, which includes provider info, connection string, ...<br>
                    The 'DbContextOptions' object is usually returned by the `DbContextOptionsBuilder` object. This class has extension method. 
                    </p>
                    
                    <pre class="brush:cpp">
                            // configure inside the XxxxContext;
                            public partial class XxxxContext : DbContext
                            {
                                protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
                                {
                                    if (!optionsBuilder.IsConfigured)
                                    {
                                        // not practical.
                                        optionsBuilder.UseNpgsql("Host=localhost;Database=dvdrental;Username=postgres;Password=password");
                                    }
                                }
                            }


                            // configure via constructor
                            // public DbContext (Microsoft.EntityFrameworkCore.DbContextOptions options);
                            public partial class XxxxContext: DbContext{
                                public XxxxContext(DbContextOptions&lt;XxxxContext> options)
                                        : base(options)
                                    { }
                            }
                            // DbContextOptions is not designed to generate directly.
                            var optionsBuilder = new DbContextOptionsBuilder&ltXxxxContext>();
                            optionsBuilder.UseNpgsql("Host=localhost;Database=dvdrental;Username=postgres;Password=password");
                            var _context = new XxxxContext(optionsBuilder.Options);
                            
                    </pre>
                    <p>When downloading a provider, e.g. PostgreSQL npgsql, it will add extension method to the DbContextOptionsBuilder class but still using 'Microsoft.EntityFrameworkCore' namespace.</p>
                    <pre class="brush:cpp">
                        // Object -> DbContextOptionsBuilder -> DbContextOptionsBuilder&lt;TContext>

                        // extension method on DbContextOptionsBuilder

                        // DbContextOptionsBuilder.Options -> DbContextOptions

                        // DbContextOptionsBuilder&lt;TContext>.Options -> DbContextOptions&lt;TContext>

                        // Object -> DbContextOptions -> DbContextOptions&lt;TContext>
                    </pre>
                </li>
                <li>
                    <h4>Configurating Models/Entities Example</h4>
                    <p>In EF Core, the configuration of each entity is done in the Context class's OnModelCreating method
                        <pre class="brush:cpp">
                            public partial class XxxxContext: DbContext{
                                protected override void OnModelCreating(ModelBuilder modelBuilder)
                                {
                                    // configurating models.
                                    modelBuilder.Entity&lt;Film>(entity =>
                                    {
                                        entity.ToTable("film"); // map to table.

                                        // create index
                                        entity.HasIndex(e => e.Fulltext)
                                            .HasName("film_fulltext_idx")
                                            .ForNpgsqlHasMethod("gist");
                                        entity.HasIndex(e => e.LanguageId)
                                            .HasName("idx_fk_language_id");
                                        entity.HasIndex(e => e.Title)
                                            .HasName("idx_title");

                                        // map column, type, default value
                                        entity.Property(e => e.FilmId).HasColumnName("film_id");
                                        entity.Property(e => e.Description).HasColumnName("description");
                                        entity.Property(e => e.Fulltext)
                                            .IsRequired()
                                            .HasColumnName("fulltext");
                                        entity.Property(e => e.LanguageId).HasColumnName("language_id");
                                        entity.Property(e => e.LastUpdate)
                                            .HasColumnName("last_update")
                                            .HasDefaultValueSql("now()");
                                        entity.Property(e => e.Length).HasColumnName("length");
                                        entity.Property(e => e.ReleaseYear).HasColumnName("release_year");
                                        entity.Property(e => e.RentalDuration)
                                            .HasColumnName("rental_duration")
                                            .HasDefaultValueSql("3");
                                        entity.Property(e => e.RentalRate)
                                            .HasColumnName("rental_rate")
                                            .HasColumnType("numeric(4,2)")
                                            .HasDefaultValueSql("4.99");
                                        entity.Property(e => e.ReplacementCost)
                                            .HasColumnName("replacement_cost")
                                            .HasColumnType("numeric(5,2)")
                                            .HasDefaultValueSql("19.99");
                                        entity.Property(e => e.SpecialFeatures).HasColumnName("special_features");
                                        entity.Property(e => e.Title)
                                            .IsRequired()
                                            .HasColumnName("title")
                                            .HasMaxLength(255);
                                        entity.Property( e=> e.Rating)
                                            .HasColumnName("rating")
                                            .HasConversion(
                                                r => RatingConverter.ToString(r),
                                                s => RatingConverter.ToEnum(s)
                                            );
                                        // relationship
                                        entity.HasOne(d => d.Language)
                                            .WithMany(p => p.Film)
                                            .HasForeignKey(d => d.LanguageId)
                                            .OnDelete(DeleteBehavior.ClientSetNull)
                                            .HasConstraintName("film_language_id_fkey");
                                    });

                                }
                            }
                        </pre>
                        In EF Framework, each entity has a Configuration class to do configuration e.g.
                        <pre class="brush:cpp">
                            public class LU_CarType{
                                // ...
                            }
                            public class LU_CarTypeConfiguration : System.Data.Entity.ModelConfiguration.EntityTypeConfiguration&lt;LU_CarType>{
                                public Configuration_FinancialInstitutionConfiguration()
                                    : this("Schema_Name")
                                {
                                }
            
                                public LU_CarTypeConfiguration(string schema)
                                {
                                    //...
                                }
                            }
                        </pre>
                </li>
                <li>
                    <h4>Configuring a entity</h4>
                    <p>
                        A entity is configured by 'naming convention' &lt; 'data annotation' &lt; 'fluent api'. Fluent API has the highest priority.
                    </p>
                    <h4>Naming Convention</h4>
                    <h4>Data Annotation</h4>
                    <h4>Fluent API</h4>
                </li>
            </ol>
        </div>
        <!--<div class="featureList">
            <h4>EF Core Model Convention</h4>
            <p>EF Core defines a few conventions for mapping Model to Database Schema</p>
            <ol>
                <li>Primary Key: Exactly One primary key exists in a Model. This primary key field's name is xxxId or Id (non case-sensitive).</li>
                <li>Foreign Key: The referenced entity is called principal entity e.g. Department in the above model. By convention, a property will
                     become a foreign key if it has same type as the referenced primary id, and its name is one of<br>
                     1). {primary key} e.g. DepartmentID<br>
                     2). {principal entity}{primary key} e.g. DepartmentDepartmentID<br>
                     3). {navigation property}{primary key} e.g.<span style="color:red">?? CoursesDepartmentID or DepartmentDepartmentID    whose navigation key?? </span>
                </li>
            </ol>
        </div>-->
    </div>
</li>
<!--<li>
    <div class="content" id="eftool">
        <h3>EF tool</h3>
        <div class="featureList">
            <ol>
                <li><h4>Install the database providers</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Sqlite
                    </pre>
                </li>
                <li><h4>Install the ef tool</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Design
                    </pre>
                </li>
                <li><h4>Generate migration code</h4>
                    <pre class="brush:bash">
                        dotnet ef migrations add InitialCreate
                    </pre>
                </li>
                <li><h4>Apply the migration code</h4>
                    <pre class="brush:bash">
                        dotnet ef database update
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>-->
<li>
<div class="content" id="reference">
<h3>References</h3>
<div class="featureList">
    <ol>
        <li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontextoptionsbuilder?view=efcore-2.1" target="_blank">DbContextOptionsBuilder</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/" target="_blank">Entity Framework Core</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/get-started/netcore/new-db-sqlite" target="_blank">Getting Started with EF Core on .NET Core Console App with a New database</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/modeling/" target="_blank">Creating and configuring a Model</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/ef6/fundamentals/relationships" target="_blank">Relationships, navigation properties and foreign keys</a></li>
    </ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
