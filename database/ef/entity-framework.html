<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<title>Database&nbsp;Entity Framework</title>
<meta charset="utf-8">
<meta name="date" content="2019-04-07">
<meta name="keywords" content="asp.net core">
<meta name="keywords" content="entity framework">
<meta name="keywords" content="database">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushPython.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushSql.js"></script>

<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />

<script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<strong>Database&nbsp;-&nbsp;Entity Framework</strong>
</div>
<p class="date"><span class="created-date">Created:2019-04-07</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2019-07-25</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#intro">Introduction</a></li>
<li><a href="#code-first">Code-first approach with PostgreSQL & SQLite</a></li>
<li><a href="#database-first">Database-first approach with PostgreSQL</a></li>
<li><a href="#in-depth">In-depth</a></li>
<!--<li><a href="#ef-tool">EF Tool</a></li>-->
<li><a href="#reference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="intro">
<h3>Introduction</h3>
<p>Entity Framework is a data access technology, mainly about accessing data from different database with C# language. (Express's Mongoose). There are two version of Entity Framework, EF 6 and EF Core. EF Core is the EF of .NET Core version; 
    EF 6 is the EF of .NET Framework. This note used EF Core as an example.</p>
<p>Besides data accessing, EF also provides design-time tools. For example, migration (code-first appraoch) helps generate tables in database from well-defined code. Vice versa, dbcontext (database-first approach) 
    helps generate C# entity class from database.</p>
<div class="featureList">
    <h4>Terminology</h4>
    <ol>
        <li>Model: A class defines the mapping from C# (.NET Core) to a database entity (table schema).</li>
        <li>Context: A class that represents a database that contains multiple tables (models). An instance of a context is also a session with the database.</li>
        <li>Database provider: the actual .NET library (plug-in) allows .NET to communicate with a specific database engine. e.g. Npgsql.EntityFrameworkCore.PostgreSQL</li>
    </ol>
</div>
<div class="featureList">
    <h4>EF tool</h4>
    <p>When installing dotnet, it also includes a sub-command called dotnet ef. It faciliates database tasks. Install the tools dependency</p>
    <pre class="brush:bash">
        dotnet add package Microsoft.EntityFrameworkCore.Design
        dotnet ef -h # check help
    </pre>
    <p>With this library, ef tool can help generate C# model from a well-defined database (database-first approach), or generate database from a well-defined C# model (code-first approach).</p>
</div>
</div>
</li>
<li>
    <div class="content" id="code-first">
        <h3>Code-first approach with SQLite</h3>
        <div class="featureList">
            <p>PostgreSQL code-first approach example.</p>
            <ol>
                <li>
                    <h4>Define Models/Entities</h4>
                    <p>** common columns/properties (e.g. Id, CreatedDate) can be extracted as a super class. ***</p>
                    <p>In the model class, defining table columns as public properties, <span style="color:red">property type can be enum</span>, also define navigation links.</p>
                    <p>For a foreign key, create a foregin key property and also an auxiliary navigation property.</p>
                    <pre class="brush:cpp">
                            public enum Gender{
                                Unknown = 0,
                                Male,
                                Female
                            }
                            public enum SchoolType{
                                Unknown = 0,
                                Elementary,
                                HighSchool,
                                College,
                                University
                            }
                            public class Student{
                                public long Id { get; set; }
                                public string Name { get; set; }
                                public DateTime DateOfBirth { get; set; }
                                public Gender Gender { get; set; }
                                public long CurrentSchoolId { get; set; }
                                // navigation property
                                public School CurrentSchool { get; set; }
                            }
                            public class School{
                                public long Id { get; set; }
                                public string Name { get; set; }
                                public SchoolType SchoolType { get; set; }
                            }
                    </pre>
                </li>
                <li>
                    <h4>Setup DbContext</h4>
                    <p>A dbcontext is class that represents a set of tables. ** One table can be involved in multiple dbcontext **. The biggest dbcontext would represent an entire database.</p>
                    <p>The <span style="color:red">Microsoft.EntityFrameworkCore</span> nuget package should be included, also always select the version that is same as the .NET Core version.</p>
                    <pre class="brush:cpp">
                            public class StudentDbContext: DbContext
                            {
                                DbSet&lt;Student> Students { get; set; }
                                DbSet&lt;School> Schools { get; set; }
                                public StudentDbContext() { }
                                public StudentDbContext(DbContextOptions&lt;StudentDbContext> options): base(options) { }
                                protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) { }
                                protected override void OnModelCreating(ModelBuilder modelBuilder){}
                            }
                    </pre>
                    <p>A db context will includes:
                        <br>1). all the needs tables/models, include them as properties with DbSet as type. <span style="color:red">DbSet implements IQueryable and IEnumerable, so they are LINQ enabled.</span> Naming practice: table name + "s";
                        <br>2). Parameterless constructor, DbContextOptions contructor. The <span class="inline-code">DbContextOptions</span> is used to configure the connection of the DbContext to the underlying database. e.g. what is the connect string, what is the database provider.;
                        <br>3). OnConfiguring is optional. It's used to configuring the dbcontext. It allows us to configure the dbcontext inside the dbcontext.;
                        <br>4). <span style="color:red">OnModelCreating</span>: this method will be called to generate database table when migrating.
                    </p>
                    <p>In real, don't provide the parameterless constructor & OnConfiguring function since we only want the dbcontext is configured by whom is using it.</p>
                </li>
                <li>
                    <h4>OnModelCreating</h4>
                    <p>Mapping C# entities to database tables can be done conventions, attributes, and Fluent API.</p>
                    <p>Moreover, for a simple project, we can write configuartion as statements inside the OnModelCreating method. For a large project, configuration of each entity class can be written as individual configuration class.</p>
                    <h4>Problems should be considered when creating a table from an entity/model</h4>
                    <p>
                        1). column names for each properties<br>
                        2). column types for each properties. For example, c# string can be mapped to varchar(n), char(n)<br>
                        2.1). varchar and array column have max length<br>
                        3). column allow to be null? <br>
                        4). column default value<br>
                        5). column value converter, e.g. database storing string but c# entity is using Enum. <span style="color:red">Even thought postgres also support Enum, but c# enum by default is mapped to postgres text</span><br>
                        6). table index, index name, unique<br>
                        7). table keys, key name<br>
                        8). table name.<br>
                        9). navigation <a href="#in-depth">Check in-depth</a>

                    </p>
                    <h4>Using Fluent API & Individual configuration class</h4>
                    <p>Fluent api use builder pattern to configure each property and each table. <span style="color:red">Install Microsoft.EntityFrameworkCore.Relational nuget package.</span></p>

                    <pre class="brush:cpp">
                            using Microsoft.EntityFrameworkCore;
                            using Microsoft.EntityFrameworkCore.Metadata.Builders;
                            using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
                            public class SchoolConfiguration: IEntityTypeConfiguration&lt;School>
                            {
                                public void Configure(EntityTypeBuilder&lt;School> builder)
                                {
                                    // setup school name.
                                    builder.ToTable("schools");

                                    // .Property method returns a PropertyBuilder
                                    builder.Property(p => p.Id)
                                        .HasColumnName("school_id")
                                        // data type targeting a relational database. This should be the complete type name, including precision, scale, length, etc.
                                        .HasColumnType("bigserial") // database vendor specific type, .e.g postgres bigserial.
                                        .IsRequired();

                                    builder.Property(p => p.Name)
                                        .HasColumnName("school_name")
                                        .HasColumnType("varchar(50)")
                                        .IsRequired();

                                    builder.Property(p => p.SchoolType)
                                        .HasColumnName("school_type")
                                        .HasColumnType("varchar(30)") // may cause error if enum name is longer than 30, by default, postgres use "text" type. 
                                        .HasConversion(new EnumToStringConverter&lt;SchoolType>())
                                        .IsRequired();

                                    // hasindex return a index builder
                                    builder.HasIndex(p => p.Name)
                                        .HasName("unique_school_name_index")
                                        .IsUnique();

                                    // haskey return a keybuilder
                                    builder.HasKey(p => p.Id)
                                        .HasName("school_pkey");
                                }
                            }
                            public class StudentConfiguration : IEntityTypeConfiguration&lt;Student>
                            {
                                public void Configure(EntityTypeBuilder&lt;Student> builder)
                                {
                                    builder.ToTable("students");
                                    builder.Property(p => p.Id)
                                        .HasColumnName("student_id")
                                        .HasColumnType("bigserial")
                                        .IsRequired();

                                    builder.Property(p => p.DateOfBirth)
                                        .HasColumnName("dateofbirth")
                                        .HasColumnType("timestamp");

                                    builder.Property(p => p.Name)
                                        .HasColumnName("name")
                                        .HasColumnType("varchar(30)")
                                        .IsRequired();

                                    builder.Property(p => p.Gender)
                                        .HasColumnName("gender")
                                        .HasConversion(new EnumToStringConverter&lt;SchoolType>())
                                        .IsRequired();

                                    builder.Property(p => p.CurrentSchoolId)
                                        .HasColumnName("school_id")
                                        .HasColumnType("bigint")
                                        .HasDefaultValue(-1)
                                        .IsRequired();

                                    builder.HasKey(p => p.Id)
                                        .HasName("student_pkey");
                                    
                                }
                            }
                    </pre>
                    <p>apply these configuration to OnModelCreating</p>
                    <pre class="brush:cpp">
                        protected override void OnModelCreating(ModelBuilder modelBuilder){
                            modelBuilder.ApplyConfiguration(new SchoolConfiguration());
                            modelBuilder.ApplyConfiguration(new StudentConfiguration());
                        }
                    </pre>
                </li>
                <li>
                    <h4>Generate migration code</h4>
                    <p>Install dotnet ef tool</p>
                    <pre class="brush:bash">
                        dotnet tool install --global dotnet-ef --version 2.2.0
                    </pre>
                    <p>When generating migration code, the tool will run against a dbcontext class, and it must know the database provider and connection string. So adding </p>
                    <pre class="brush:cpp">
                        public class StudentDbContext: DbContext{
                            protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) { 
                                optionsBuilder.UseNpgsql("Host=localhost;Username=postgres;Password=postgres;Database=student_db");
                            }
                        }
                    </pre>
                    <p>Another approach is add the optionsbuilder into dependency injection (service provider)</p>
                    <p class="reference-box">
                        A provider can be configured by overriding the DbContext.OnConfiguring method or by using AddDbContext on the application service provider. If AddDbContext is used, then also ensure that your DbContext type accepts a DbContextOptions&lt;TContext> 
                    </p>
                    <p>Migration code can be generate by running </p>
                    <pre class="brush:bash">
                        # generating migration code for the specific context. {context} is the context class name.
                        dotnet ef migrations add migration_20190725 -o Migrations --context StudentDbContext
                    </pre>
                    <p>It will generate 3 files.</p>
                </li>
                <li>
                    <h4>Apply migration</h4>
                    <p>Migration can be applied via programming or cmd.</p>
                    <p>1. CMD, running</p>
                    <pre class="brush:bash">
                            dotnet ef database update --context StudentDbContext
                    </pre>
                    <p>It runs against the context class, so provide configuration in the context.</p>
                    <p>2. Programming, when an application is start, acquiring dbcontext object, and invoke <span class='inline-code'>.Migrate()</span></p>
                    <pre class="brush:bash">
                        var optionsBuilder = new DbContextOptionsBuilder&lt;StudentDbContext>();
                        optionsBuilder.UseNpgsql("Host=localhost;Username=postgres;Password=postgres;Database=student_db");
                        var dbContext = new StudentDbContext(optionsBuilder.Options);
                        dbContext.Database.Migrate();
                    </pre>
                </li>
            </ol>
        </div>
        <h4>Summary</h4>
        <p>Model configuration and DbContext configuration are using builder pattern.<br>
        Microsoft.EntityFrameworkCore itself defines all the method to build/configure model.<br>
        DbContext configuration/option is primarly built by 3rd party extension methods.
        </p>
        <p>SQLite Example</p>
        <div class="featureList">
            <ol>
                <li><h4>Install dependency</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore
                        dotnet add package Microsoft.EntityFrameworkCore.Sqlite # sqlite provider
                        dotnet add package Microsoft.EntityFrameworkCore.Design 
                    </pre>
                </li>
                <li><h4>Define model and context</h4>
                    <p>Add configuration inside the context, write fluent statement inside the onmodelcreating.</p>
                    <pre class="brush:cpp">
                            using Microsoft.EntityFrameworkCore;
                            using System.Collections.Generic;
                            using System.ComponentModel.DataAnnotations;
                            using System.ComponentModel.DataAnnotations.Schema;
                            public class TripContext : DbContext
                            {
                                public DbSet&lt;Trip> Trips { get; set; }
                                public DbSet&lt;Location> Locations { get; set; }
                                protected override void OnModelCreating(ModelBuilder modelBuilder)
                                {
                                    modelBuilder.Entity&lt;Location>()
                                        .HasKey(c => new {c.TripId, c.Count}); // this is Fluent API used to define composite key
                                }
                                protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
                                {
                                    optionsBuilder.UseSqlite("Data Source=trips.db");
                                }
                            }
                            public class Trip{
                                [Key] // using attribute to specify key. EF core only support single field key.
                                public int TripId {get; set;}
                                public string TripName {get; set;}
                            }
                            public class Location{
                                public int TripId {get; set;}
                                public int Count {get; set;}
                                public int Long {get; set;}
                                public int Lat {get; set;}
                            }
                    </pre>
                    Run
                    <pre class="brush:bash">
                        # scaffold the models (generate code that initialize the database)
                        dotnet ef migrations add InitialCreate
                        # apply the generated code to initialize database. (In case of using SQLite, it will generate a file .db)
                        dotnet ef database update      
                    </pre>
                </li>
                <li><h4>Using the database</h4>
                    <pre class="brush:cpp">
                            class Program
                            {
                                static void Main(string[] args)
                                {
                                    using (var db = new TripContext())
                                    {
                                        db.Trips.Add(new Trip { TripName = "The first trip" });
                                        int count = db.SaveChanges();
                                        Console.WriteLine("{0} records saved to database", count);
                        
                                        Console.WriteLine();
                                        Console.WriteLine("All trip in database:");
                                        foreach (Trip trip in db.Trips)
                                        {
                                            Console.WriteLine(" - {0} {1}", trip.TripId, trip.TripName);
                                        }
                                    }
                                }
                            }
                    </pre>
                </li>
                <li>Inject by ASP.NET Core Injection Container
                    <pre class="brush:cpp">
                        // register service 
                        services.AddDbContext&lt;ApplicationDbContext>(options =>
                            options.UseSqlite(
                                Configuration.GetConnectionString("DefaultConnection")));
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="database-first">
        <h3>Database-first approach with PostgreSQL</h3>
        <p>Restoring database from the <a href="http://www.postgresqltutorial.com/postgresql-sample-database/" target="_blank">dvdrental example.</a> <a href="./db-sample/dvdrental.tar">Download</a></p>
        <div class="featureList">
            <ol>
                <li>
                    <h4>Install dependencies</h4>
                    <p> *** Keep the major version of dotnet core, ef tool, and provider same.</p>
                    <pre class="brush:bash">
                            # npgsql 2.2 supports ef 2.2
                            dotnet add package Microsoft.EntityFrameworkCore.Design --version=2.2.0 
                            dotnet add package Npgsql.EntityFrameworkCore.PostgreSQL --version=2.2.0 # provider
                    </pre>
                </li>
                <li><h4>Connection string</h4>
                <p>Each database server has its own connection string format. There also exist different proposes connection string<br>
                    e.g.1).  standard security: connect with username + password<br>
                        2).  trusted connection: connection is verified with domain.<br>
                </p>
                <p>Example (case-insensitive):<br>
                    1).SQL Server standard: Server=localhost;Database=dvdrental;User Id=myUsername; Password=myPassword;<br>
                    2).SQL Server trusted connection: Server=localhost;Database=dvdrental;trusted_connection=true;<br>
                    3).PostgreSQL standard: Host=localhost;Database=dvdrental;Username=postgres;Password=password
                </p>
                </li>
                <li>
                    <h4>Generate C# models</h4>
                    <pre class="brush:bash">
                        # from a PostgreSQL database
                        dotnet ef dbcontext scaffold "Host=localhost;Database=dvdrental;Username=postgres;Password=password" Npgsql.EntityFrameworkCore.PostgreSQL -o Models
                        # from a SQL Server database with specifying a specific schema and output json format of generated files.
                        dotnet ef dbcontext scaffold "Server=localhost;Database=dvdrental;trusted_connection=true;" Microsoft.EntityFrameworkCore.SqlServer --output-dir Models.Configuration --schema Configuration --json
                        # generate entity class for specified tables.
                        dotnet ef dbcontext scaffold \
                            "Server=localhost;Database=dvdrental;trusted_connection=true;" Microsoft.EntityFrameworkCore.SqlServer
                            --output-dir Models \
                            --table public.actor \
                            --table public.film \
                            --json
                        # the entity class name is same as table name, so if two schames have tables with same name, then ... [some entities will not be generated.]
                    </pre>
                    <p>** When generating dvdrental from postgrestutorial.com, the imported database set primary key as integer, but foreign key as smallint. So before running the above command, using pgAdmin modifies the foreign key to integer type.</p>
                </li>
                <li>
                    <h4>PostgreSQL enum type</h4>
                    <p>PostgreSQL supports enum (SQL server doesn't). As the user's prespective, enum is like string, but the underlying storage is int.</p>
                    <p>But in C# model, we have to manually define the enum type and add the attribute to C# model.</p>
                    <pre class="brush:sql">
                            -- example of SQL defined enum type.
                            CREATE TYPE public.mpaa_rating AS ENUM
                            ('G', 'PG', 'PG-13', 'R', 'NC-17');                        
                    </pre>
                    <pre style="border:1px solid green;border-radius:15px; width:600px; padding:10px;">Enum flow
                        C# Enum Rating.PG13;
                        -- C# convert function --
                        C# string 'PG-13'
                        -- dbContext --
                        postgreSQL enum 'PG-13'
                        postgreSQL underlying storage 1

                    </pre>
                    Define the C# enum and converting class.
                    <pre class="brush:cpp">
                            
                            public enum Rating{
                                G, 
                                PG, 
                                PG13, 
                                R, 
                                NC17 
                           }
                           public static class RatingConverter{
                               public static Rating ToEnum(string rating){
                                   switch(rating){
                                       case "G": return Rating.G;
                                       case "PG": return Rating.PG;
                                       case "PG-13": return Rating.PG13;
                                       case "R": return Rating.R;
                                       default: return Rating.NC17;
                                   }
                               }
                               public static string ToString(Rating r){
                                   switch(r){
                                       case Rating.G: return "G";
                                       case Rating.PG: return "PG";
                                       case Rating.PG13: return "PG-13";
                                       case Rating.R: return "R";
                                       default: return "NC-17";
                                   }
                               }
                               public static ValueConverter&lt;Rating, string> GetConverter(){
                                   return new ValueConverter&lt;Rating, string>(
                                       r => ToString(r),
                                       s => ToEnum(s)
                                   );
                               }
                           }
                    </pre>
                    Add the rating attribute to Model
                    <pre class="brush:cpp">
                        // ...
                        public Rating Rating {get; set;}
                        // ...
                    </pre>
                    Register value converter under OnModelCreating
                    <pre class="brush:cpp">
                        entity.Property( e=> e.Rating)
                            .HasColumnName("rating")
                            .HasConversion(RatingConverter.GetConverter());
                    </pre>
                </li>
                <li>
                    <h4>Using the context</h4>
                    <pre class="brush:cpp">
                            dvdrentalContext _context = new dvdrentalContext();
                            foreach (var item in _context.Film)
                            {
                                Console.WriteLine("{0} | {1}", item.Title, item.Rating);
                            }
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>
<li>
    <div class="content" id="in-depth">
        <h3>In-depth</h3>
        <h4>Entity Framework Core Model</h4>
        <p>A EF Core Model is a C# class used to represent an entity in the database. It is in the conceptual layer.So 
            when creating a model, just think about creating a table with SQL. Field, fields domain, primary key, foreign key, constraints</p>
        <h4>Fluent API</h4>
        <p>Fluent API: configure C# Model (entity) to map to database field, type and constraints. It is important when using code-first approach because they instruct EF Core to create database.</p>
        <div class="featureList">
            <ol>
                <li>
                    <h4>Model/Entity class (EF Core example)</h4>
                    <p>film: primary key (film_id), foreign keys (language_id -> language.language_id)<br><br>
                        film_actor: film_id -> film.film_id<br>
                        film_category: film_id -> film.film_id<br>
                        inventory: film_id -> film.film_id
                    </p>
                    <pre class="brush:sql">
                            CREATE TABLE public.film
                            (
                                film_id integer NOT NULL DEFAULT nextval('film_film_id_seq'::regclass),
                                title character varying(255) COLLATE pg_catalog."default" NOT NULL,
                                description text COLLATE pg_catalog."default",
                                release_year year,
                                language_id integer NOT NULL,
                                rental_duration smallint NOT NULL DEFAULT 3,
                                rental_rate numeric(4,2) NOT NULL DEFAULT 4.99,
                                length smallint,
                                replacement_cost numeric(5,2) NOT NULL DEFAULT 19.99,
                                rating mpaa_rating DEFAULT 'G'::mpaa_rating,
                                last_update timestamp without time zone NOT NULL DEFAULT now(),
                                special_features text[] COLLATE pg_catalog."default",
                                fulltext tsvector NOT NULL,
                                CONSTRAINT film_pkey PRIMARY KEY (film_id),
                                CONSTRAINT film_language_id_fkey FOREIGN KEY (language_id)
                                    REFERENCES public.language (language_id) MATCH SIMPLE
                                    ON UPDATE CASCADE
                                    ON DELETE RESTRICT
                            );
                    </pre>
                    <pre class="brush:cpp">
                            public partial class Film
                            {
                                public Film()
                                {
                                    // other entities refer to film. 
                                    // one film -- many others.
                                    FilmActor = new HashSet&lt;FilmActor>();
                                    FilmCategory = new HashSet&lt;FilmCategory>();
                                    Inventory = new HashSet&lt;Inventory>();
                                }

                                    public int FilmId { get; set; }
                                    public string Title { get; set; }
                                    public string Description { get; set; }
                                    public int? ReleaseYear { get; set; }
                                    public int LanguageId { get; set; }
                                    public short RentalDuration { get; set; }
                                    public decimal RentalRate { get; set; }
                                    public short? Length { get; set; }
                                    public decimal ReplacementCost { get; set; }
                                    public Rating Rating {get; set;}
                                    public DateTime LastUpdate { get; set; }
                                    public string[] SpecialFeatures { get; set; }
                                    public NpgsqlTsVector Fulltext { get; set; }

                                    public virtual Language Language { get; set; } // many film : one language

                                    public virtual ICollection&lt;FilmActor> FilmActor { get; set; } // one film : many filmActor
                                    public virtual ICollection&lt;FilmCategory> FilmCategory { get; set; } // one film: many FilmCategory
                                    public virtual ICollection&lt;Inventory> Inventory { get; set; } // one film: many inventory
                                }
                    </pre>
                    <p>Shadow Properties: a property may not be declared in a Model class, but it will be created by the EF Core or by developer specified OnModelCreating method in the database table.<br>
                    .e.g. A "LastUpdate" may add to a database but it is not defined in db entity class and never used.
                    </p>
                </li>
                <li>
                    <h4>DbContext Configuration</h4>
                    <p>DbContext is initialized before using a database or generating a database from code.</p>
                    <p><span style="color:green">EF Core configuring a DbContext</span><br>
                    A DbContext is initialized with a 'DbContextOptions' object, which includes provider info, connection string, ...<br>
                    The 'DbContextOptions' object is usually returned by the `DbContextOptionsBuilder` object. This class has extension method. 
                    </p>
                    
                    <pre class="brush:cpp">
                            // configure inside the XxxxContext;
                            public partial class XxxxContext : DbContext
                            {
                                protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
                                {
                                    if (!optionsBuilder.IsConfigured)
                                    {
                                        // not practical.
                                        optionsBuilder.UseNpgsql("Host=localhost;Database=dvdrental;Username=postgres;Password=password");
                                    }
                                }
                            }
                            // configure via constructor
                            // public DbContext (Microsoft.EntityFrameworkCore.DbContextOptions options);
                            public partial class XxxxContext: DbContext{
                                public XxxxContext(DbContextOptions&lt;XxxxContext> options)
                                        : base(options)
                                    { }
                            }
                            // DbContextOptions is not designed to generate directly.
                            var optionsBuilder = new DbContextOptionsBuilder&ltXxxxContext>();
                            optionsBuilder.UseNpgsql("Host=localhost;Database=dvdrental;Username=postgres;Password=password");
                            var _context = new XxxxContext(optionsBuilder.Options);
                            
                    </pre>
                    <p>When downloading a provider, e.g. PostgreSQL npgsql, it will add extension method to the DbContextOptionsBuilder class but still using 'Microsoft.EntityFrameworkCore' namespace.</p>
                    <pre class="brush:bash">
                        Object -> DbContextOptionsBuilder -> DbContextOptionsBuilder&lt;TContext>
                        extension method on DbContextOptionsBuilder
                        DbContextOptionsBuilder.Options -> DbContextOptions
                        DbContextOptionsBuilder&lt;TContext>.Options -> DbContextOptions&lt;TContext>
                        Object -> DbContextOptions -> DbContextOptions&lt;TContext>
                    </pre>
                </li>
                <li>
                    <h4>Convention based relationship (foreign key + navigation property)</h4>
                    <p>When a property's type is a complex class, then it will be considered as a nagviation properties.</p>
                    <p class="reference-box">
                        Collection navigation property: A navigation property that contains references to many related entities.<br>
                        Reference navigation property: A navigation property that holds a reference to a single related entity.<br>
                        Inverse navigation property: When discussing a particular navigation property, this term refers to the navigation property on the other end of the relationship.
                    </p>
                    <p>If it is a refernce navigation property, then ef will create a foreign key in this table. If the C# model class defined a property has name same as<br>
                        1). primary key of the referenced entity<br>
                        2). navigation property + primary key of the referenced entity<br>
                        3). referenced entity name + primary key of the referenced entity.<br>
                        then this property will be used as the foreign key. Otherwise, ef will create a shadow property to be the foreign key.
                    </p>
                    <pre class="brush:cpp">
                        public class School{
                            // schools table with school_id as PK.
                            public long SchoolId;
                        }
                        public class Student{
                            public School SchoolRef; // navigation property.
                            // the following properties can be used as foregin key by convention.
                            public long SchoolId; // third priority
                            public long SchoolRefSchoolId; // first priority
                            public long SchoolSchoolId; // second priority
                        }
                    </pre>
                    <p>If the C# model does not define the foreign key property, ef will create a shadow property named {Navigation Property}{Primary Key}</p>
                    <h4>Reference back</h4>
                    <p>After an entity A references to another entity B, then B can reference back to a single entity A (inverse navigation property: one-to-one) or a list of entity A (collection navigation property: many-to-one)</p>
                    <h4>Inverse navigation property</h4>
                    <p>One-to-One, one and only one entity needs to define the foreign key explicitly, and it doesn't affect the underlying database. It's EF provided feature. One-to-One is not commonly used, since if they are one, then they basically can be stored as one entity.</p>
                    <p>** With reference navigation property, inverse navigation property will be the reference navigation property.</p>
                    <h4>Collection navigation property</h4>
                    <p>Collection navigation propery is commonly used, and it doesn't affect the underlying database. It's EF provided feature.</p>
                    <p>Without reference navigation property, EF will still add a shadow foreign key into the "Student" entity.</p>
                    <p span style="color:red">On restricted when school is deleted</p>
                </li>
                <li>
                    <h4>Fluent API based relationship</h4>
                    <p>In EF Core, the configuration of each entity is done in the Context class's OnModelCreating method</p>
                    <pre class="brush:cpp">
                        public class StudentDbContext: DbContext{
                            protected override void OnModelCreating(ModelBuilder modelBuilder){
                                // configurating models.
                                modelBuilder.Entity&lt;Student>(entity =>{
                                    // relationship
                                    entity.HasOne(std => std.CurrentSchool) // ReferenceNavigationBuilder
                                        .WithMany(scl => scl.Students) // ReferenceCollectionBuilder
                                        .HasForeignKey(std => std.CurrentSchoolId) // ReferenceCollectionBuilder
                                        .OnDelete(DeleteBehavior.Cascade) // ReferenceCollectionBuilder
                                        .HasConstraintName("refernce_constraint");
                                }
                            }
                    </pre>
                    <p>The on delete behavior can be set as restrict, set null and cascade. But since the foreign key is required not null, and ef migration tool is smart, it will ignored setnull and use restrict.</p>
                </li>
            </ol>
        </div>
        
    </div>
</li>

<!--<li>
    <div class="content" id="eftool">
        <h3>EF tool</h3>
        <div class="featureList">
            <ol>
                <li><h4>Install the database providers</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Sqlite
                    </pre>
                </li>
                <li><h4>Install the ef tool</h4>
                    <pre class="brush:bash">
                        dotnet add package Microsoft.EntityFrameworkCore.Design
                    </pre>
                </li>
                <li><h4>Generate migration code</h4>
                    <pre class="brush:bash">
                        dotnet ef migrations add InitialCreate
                    </pre>
                </li>
                <li><h4>Apply the migration code</h4>
                    <pre class="brush:bash">
                        dotnet ef database update
                    </pre>
                </li>
            </ol>
        </div>
    </div>
</li>-->
<li>
<div class="content" id="reference">
<h3>References</h3>
<div class="featureList">
    <ol>
        <li><a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontextoptionsbuilder?view=efcore-2.1" target="_blank">DbContextOptionsBuilder</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/" target="_blank">Entity Framework Core</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/get-started/netcore/new-db-sqlite" target="_blank">Getting Started with EF Core on .NET Core Console App with a New database</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/core/modeling/" target="_blank">Creating and configuring a Model</a></li>
        <li><a href="https://docs.microsoft.com/en-us/ef/ef6/fundamentals/relationships" target="_blank">Relationships, navigation properties and foreign keys</a></li>
    </ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
