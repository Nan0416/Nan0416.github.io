<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_151) on Sun Oct 08 22:41:36 PDT 2017 -->
<title>Mongodb&nbsp;Mongoose</title>
<meta charset="utf-8">
<meta name="date" content="2018-04-07">
<meta name="keywords" content="Mongodb">
<meta name="keywords" content="Mongoose">
<meta name="keywords" content="NoSQL">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJava.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushJScript.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushBash.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />



</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<center><strong>Mongodb&nbsp;-&nbsp;Mongoose</strong></center>
</div>
<p class="date"><span class="created-date">Created:2018-04-07</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2018-04-14</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#mongooseIntro">Introduction</a></li>
<li><a href="#mongooseSchema">Define Schema</a></li>
<li><a href="#mongooseUsage">Use Schema</a></li>
<li><a href="#mongooseReference">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="mongooseIntro">
<h3>Introduction</h3>
<p>MongoDB’s documents are no structure, any document can be stored in any collection, relies on developer’s discipline to maintain the structure of the documents.</p>
<p>Mongoose is a node package that provides a interface to communicate with the mongodb. Besides this, it also helps define schema for storing data.</p>
<p>Mongoose is built on the top of the native mongodb node driver.</p>
<p>Mongoose's schema makes the documents as a well-oragnized structure, and also provides validation</p>
<h4>Mongoose ODM</h4>
<p>ODM (Object Data Model, Object Document Mapping)</p>
<p>Mongoose defines schema, the schema defines data field, data type and other properties.</p>
<h4>Data type</h4>
<p>The data type can be String, Number, Date, Buffer, Boolean, Mixed, ObjectId, Array</p>
<p>There are also 3rd party types, e.g. mongoose-currency</p>
<h4>Promise</h4>
<p>Mongoose requires us to specify the Promise. A 3rd party implemented Promise is used "bluebird"</p>
<pre class="brush:js">
// in the app.js or index.js
const mongoose = require('mongoose');
mongoose.Promise = require('bluebird');
</pre>
</div>
</li>
<li>
<div class="content" id="mongooseSchema">
<h3>Define Schema</h3>
<p>Each schema is a collection (or sub-collection) and all the documents within the collection will obey this schema.</p>
<h4>Example</h4>
<pre class="brush:js">
const mongoose = require('mongoose'); 
const Schema = mongoose.Schema;

const commentSchema = new Schema({
    rating: {
        type:Number,
        min: 1,
        max: 5,
        required: true
    },
    comment:{
        type:String,
        required: true
    },
    author:{
        type: String,
        required: true
    }
},{
    timestamps: true
});
</pre>
<p>The schema takes two parameters
<br>1. definition: a object that specifies each field name and features. Features include type, required, default value, and max, min.
<br>2. optional: directive to the mongoose</p>
<div class="featureList">
<ol>
<li><span style="color:blue">timstamps: true</span>
Insert two fields, updatedAt and createdAt
</li>
<li><span style="color:blue">versionKey: "_version__"</span>
By default, there is a __v feild will be inserted to the schema, which indicate the version of the document.
If the number __v is conflict with developer's name, updates it here.
</li>
</ol>
</div>
<h4>Embedded Schema</h4>
<p><span style="color:red">A Feature That Cannot Be Given By SQL Databases.</span></p>
<pre class="brush:js">
const dishSchema = new Schema({
    name:{
        type:String,
        required: true,
        unique: true
    },
    description: {
        type:String,
        required: true,
    },
    comments:[commentSchema]
    /* 
    comments:{
        type: [commentSchema],
        required: false
    }
    */
},{
    timestamps: true,
    usePushEach:true
});
</pre>
<p>The commentSchema is not a sub-schema of the dishSchema.</p>
<h4>Comparison between separate schema and embedded schema</h4>
<p><a href="http://openmymind.net/Multiple-Collections-Versus-Embedded-Documents/" target="_blank">Reference</a></p>
</div>
</li>
<li>
<div class="content" id="mongooseUsage">
<h3>Use Schema</h3>
<p>require('./dishSchema') return a Model object.</p>
<p>Most Promise then gives a Document object.</p>
<div class="featureList">
<ol>
<li>
<p><span style="color:red">Insert a document</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    var data = {
        name:"KongPao",
        description:"Sichuan dish",
        comments:[
            {
                rating:4,
                comment:"hot",
                author:"qinnan"
            }
        ]
    };
    dishSchema.create(data) // a object that satisfies the schema definition
    .then((dish)=>{ // Promise, return the object
        
    }, (err)=>{
        
    });
</pre>
</li>
<li>
<p><span style="color:red">Insert a sub-document</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    var comment = {
        rating:3,
        comment:"bad taste",
        author:"Nate"
    }
    dishSchema.findById('1234324de823231')
    .then((dish)=>{
        if (dish != null) {
            dish.comments.push(comment);
            dish.save()
            .then((dish)=>{

            }, (err)=>{

            });
        }
    }, (err)=>{
        
    });
</pre>
</li>
<li>
<p><span style="color:red">Find a document</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    dishSchema.findById('1234324de823231') // a object that satisfies the schema definition
    .then((dish)=>{ // Promise, return the object
        
    }, (err)=>{
        
    });
</pre>
</li>
<li>
<p><span style="color:red">Find a sub-document</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    dishSchema.findById('1234324de823231') // a object that satisfies the schema definition
    .then((dish)=>{ // Promise, return the object
        dish.comments.id('323234243e432f3r');
        // Mongoose document arrays have a special id method for searching a document array to find a document with a given _id.
    }, (err)=>{
        
    });
</pre>
</li>
<li>
<p><span style="color:red">Update a document</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    dishSchema.findByIdAndUpdate('1234324de823231'
        {$set: {description: "Szechwan"}}, // the field need updates, $set is a mongodb operator
        {new: true}) // return the modified document, otherwise the original document
    .then((dish)=>{ // Promise, return the object
        
    }, (err)=>{
        
    });
</pre>
</li>
<li>
<p><span style="color:red">Update a sub-document</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    dishSchema.findById('1234324de823231')
    .then((dish)=>{
        if (dish != null) {
            var comment = dish.comments.id('12232y43473dww234'); // find comments
            if (comment != null) {
                comment.rating = 5;
                dish.save() // save the change
                .then((dish) =>{

                }, (err)=>{

                });
            }
        }
    }, (err)=>{
        
    });
</pre>
</li>
<li>
<p><span style="color:red">Delete all documents</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    dishSchema.remove({})
    .then((resp)=>{ 
        // the resp is a json that indicates the deleted number of documents
        /*{
            "n":4,
            "ok":1
        }*/
    }, (err)=>{
        
    });
</pre>
</li>
<li>
<p><span style="color:red">Delete a document</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    dishSchema.findByIdAndRemove('1234324de823231')
    .then((dish)=>{ 
        
    }, (err)=>{
        
    });
</pre>
</li>
<li>
<p><span style="color:red">Delete a sub-document</span></p>
<pre class="brush:js">
    const dishSchema = require('../models/dishes');
    dishSchema.findById('1234324de823231')
    .then((dish)=>{
        if (dish != null) {
            var comment = dish.comments.id('12232y43473dww234'); // find comments
            if (comment != null) {
                comment.remove();
                dish.save() // save the change
                .then((dish) =>{

                }, (err)=>{

                });
            }
        }
    }, (err)=>{
        
    });
</pre>
</li>
</ol>
</div>
</div>
</li>
<li>
<div class="content" id="mongooseReference">
<h3>References</h3>
<div class="featureList">
<ol>
<li><a href="http://mongoosejs.com/docs/api.html" target="_blank">Mongoose API v5</a></li>
</ol>
</div>
</div>
</li>
</ol>
</div>
</body>
</html>
