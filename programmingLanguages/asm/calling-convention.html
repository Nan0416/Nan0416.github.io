<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (1.8.0_151) on Sun Oct 08 22:41:36 PDT 2017 -->
<title>ASM&nbsp;Calling convention</title>
<meta charset="utf-8">
<meta name="date" content="2018-01-22">
<meta name="keywords" content="delay">
<meta name="keywords" content="asm">
<meta name="keywords" content="microcontroller">
<link rel="stylesheet" type="text/css" href="../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../script.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/XRegExp.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shCore.js"></script>
<script type="text/javascript" src="../../syntaxHighlight_js_c/shBrushCpp.js"></script>
<link href="../../syntaxHighlight_css_c/shCore.css" rel="stylesheet" type="text/css" />
<link href="../../syntaxHighlight_css_c/shThemeDefault.css" rel="stylesheet" type="text/css" />



</head>
<body>
<script>
SyntaxHighlighter.config.strings.expandSource = '+ expand source';
SyntaxHighlighter.config.strings.help = '?';
SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
SyntaxHighlighter.defaults['pad-line-numbers'] = false;
SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all()
</script>

<!-- ========= START OF TOP NAVBAR ======= -->
<div class="bar">
<center><strong>ASM&nbsp;-&nbsp;Calling Convention</strong></center>
</div>
<p class="date"><span class="created-date">Created:2018-01-21</span>&nbsp;&nbsp;<span class="last-modified">Last modified:2018-01-23</span></p>
<div class="catalog">
<ul class="catalogItems">
<li><a href="#callingIntro">Introduction</a></li>
<li><a href="#callingConvention">Details</a></li>
<li><a href="#callingReferences">References</a></li>
</ul>
</div>
<hr>
<div class="contentContainer">
<ol>
<li>
<div class="content" id="callingIntro">
<h3>Introduction</h3>
<p>SP is post-decrement, which means the SP points to a empty slot in the most time</p>
<p>r1 is called __zero_reg_, we use it as a register that always store a 0. It is handy</p>
<p>r0 is called __tmp_reg_, we use it as a temporary register that stores anything we do not care, e.g. pop r0</p>
</div>
</li>
<li>
<div class="callingConvention">
<h3>Details</h3>
<div class="featureList">
<ol>
<li>
<h4>No arguments, No return value</h4>
<pre class="brush: cpp">
        void func();
        int main(){
            func();
        }
        void func(){
            unsigned char a = 10;
            a++;
        }
</pre>
<div class="asm" style="margin-right:300px">
<pre>
        00000000 &lt;main>:
                0:	cf 93       	push	r28
                2:	df 93       	push	r29  ;; save Y   
                4:	cd b7       	in	r28, 0x3d	; 61
                6:	de b7       	in	r29, 0x3e	; 62       
        ;; Nan stack pointer is in I/O space, this step load the SP into Y pointer.
                8:	0e 94 09 00 	call	0x12	; 0x12 &lt;func> 
        ;; Nan Call push PC + 2 (pre-increment), then set PC to be 0x12 (destination)
                c:	df 91       	pop	r29
                e:	cf 91       	pop	r28
               10:	08 95       	ret
             
        00000012 &lt;func>:
               12:	cf 93       	push	r28 ;;
               14:	df 93       	push	r29 
        ;; Nan Backup SP. 
               16:	1f 92       	push	r1 ;; push a 0 onto stack ???? alignment, or secure??
               18:	cd b7       	in	r28, 0x3d	; 61
               1a:	de b7       	in	r29, 0x3e	; 62 
        ;; Load new SP.
               1c:	8a e0       	ldi	r24, 0x0A	; 10
               1e:	89 83       	std	Y+1, r24	; 0x01
               20:	89 81       	ldd	r24, Y+1	; 0x01 
        ;; treat Y as a SP, but the real SP does not change
               22:	8f 5f       	subi	r24, 0xFF	; 255
               24:	89 83       	std	Y+1, r24	; 0x01
               26:	0f 90       	pop	r0
               28:	df 91       	pop	r29 
               2a:	cf 91       	pop	r28
               2c:	08 95       	ret 
        ;; return pop the stored PC value into PC register 
</pre>
</div>
<p>Each function start with saving Y pointer into the stack. And load SP into Y. Inside a function, using the Y as SP, the real SP does not change (
    even though we use stack, but we don't use push or pop in the middle of function). At the end, backup Y pointer via the pop.</p>
</li>
</ol>
</div>
</div>
</li>



<li>
<div class="content" id="delayIntro">
<h3>Introduction</h3>
gcc -c -g -Wa,-a,-ad [other GCC options] foo.c > foo.lst
<p>Analyze: this delay is based on while a loop.</p>
int i = 0;
while(i &lts; 256){
    i++;
}
; opcode dst, src
main:
mov r17, 0;
mov r18, 0xff
.LOOP:
cmp r17, r18
jle Main
inc r17
jmp .LOOP:
</div>
</li>
<li>
<div class="content" id="callingReference">
<h3>References</h3>
<div class="featureList">
<ol>
<li><a href="https://www.cs.colostate.edu/~cs453/yr2013/Slides/06-AVR.txt" target="_blank">CS453 Colorado State University</a></li>
</ol>
</div>
</div>
</li>
</ol>
</div>
    
</body>
</html>
